<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Community â€“ OpsLinkCAD</title>

    <style>
        :root {
            --bg-main: #0f141a;
            --bg-card: #161b22;
            --bg-hover: #1a222e;

            --border: #222c36;
            --border-soft: #1f2630;

            --accent: #4e8cff;
            --accent-hover: #6fa2ff;

            --text-main: #e5e9f0;
            --text-soft: #9aa5b1;

            --danger: #ff4c4c;
            --danger-hover: #ff6060;
        }

        body {
            margin: 0;
            background: var(--bg-main);
            font-family: "Segoe UI", sans-serif;
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* ===============================
           SIDEBAR
        =============================== */
        .sidebar {
            width: 250px;
            background: var(--bg-card);
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            padding: 20px;
            border-right: 1px solid var(--border-soft);
        }

        .sidebar .logo {
            font-size: 26px;
            margin-bottom: 25px;
            color: var(--accent);
            font-weight: 700;
        }

        .sidebar a, .nav-item {
            display: block;
            padding: 12px 14px;
            margin: 6px 0;
            border-radius: 6px;
            font-size: 15px;
            text-decoration: none;
            cursor: pointer;
            color: var(--text-soft);
            transition: 0.2s;
        }

        .sidebar a:hover,
        .nav-item:hover,
        .sidebar a.active {
            background: var(--bg-hover);
            color: var(--accent);
        }

        /* ===============================
           MAIN
        =============================== */
        .main {
            margin-left: 260px;
            padding: 40px;
        }

        .dash-title {
            font-size: 35px;
            color: var(--accent);
            margin-bottom: 6px;
        }

        .user-tag {
            opacity: 0.7;
            margin-bottom: 25px;
        }

        /* ===============================
           SECTIONS
        =============================== */
        .section {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .section h2 {
            margin-bottom: 8px;
            color: var(--accent);
        }

        .divider {
            height: 1px;
            width: 100%;
            background: var(--border-soft);
            margin: 15px 0;
        }

        input.dash-input,
        .dash-input-select {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-soft);
            background: #0f141a;
            color: var(--text-main);
            margin-bottom: 10px;
        }

        .btn-primary {
            padding: 10px 18px;
            border-radius: 6px;
            background: var(--accent);
            border: none;
            color: white;
            font-size: 15px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-small {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            transition: 0.2s;
        }

        .btn-small:hover {
            background: var(--accent);
            color: #fff;
        }

        .danger-btn {
            border-color: var(--danger);
            color: var(--danger);
        }

        .danger-btn:hover {
            background: var(--danger);
            color: #fff;
        }

        /* ===============================
           TABLES
        =============================== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid var(--border-soft);
        }

        th {
            color: var(--accent);
            text-align: left;
        }

        /* ===============================
           COLLAPSIBLE SECTIONS
        =============================== */
        details {
            background: #131a22;
            border: 1px solid var(--border-soft);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        summary {
            cursor: pointer;
            color: var(--accent);
            font-size: 16px;
            font-weight: 600;
        }

        details[open] summary {
            margin-bottom: 10px;
        }

        /* ===============================
           MODAL
        =============================== */
        .modal-bg {
            position: fixed;
            display: none;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal {
            background: var(--bg-card);
            padding: 25px;
            width: 380px;
            border-radius: 10px;
            border: 1px solid var(--accent);
        }

        .modal input,
        .modal select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #0f141a;
            border: 1px solid var(--border-soft);
            border-radius: 6px;
            color: white;
        }

        .close-btn {
            background: #222;
            opacity: 0.7;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            border: none;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .pill {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid var(--border-soft);
            margin-right: 4px;
            margin-bottom: 2px;
        }
    </style>
</head>

<body>

<!-- ===============================
     SIDEBAR
=============================== -->
<div class="sidebar">
    <div class="logo">OpsLink<span style="color:white">CAD</span></div>

    <a href="dashboard.html">Dashboard</a>

    <a class="nav-item active" data-panel="panel-community">Community</a>

    <a class="nav-item" data-panel="panel-claim">Enter Access Key</a>

    <a id="supervisorNav" class="nav-item" data-panel="panel-supervisor">Supervisor Panel</a>
    <a id="adminNav" class="nav-item" data-panel="panel-admin">Admin Panel</a>
    <a id="dispatchNav" class="nav-item" data-panel="panel-dispatch">Dispatch Console</a>
    <a id="mdtNav" class="nav-item" data-panel="panel-mdt">LEO MDT</a>
    <a id="fireNav" class="nav-item" data-panel="panel-fire">Fire / EMS Panel</a>
    <a id="permKeyNav" class="nav-item" data-panel="panel-keys">Permission Keys</a>

    <a href="#" onclick="logout()">Logout</a>
</div>

<!-- ===============================
     MAIN CONTENT WRAPPER
=============================== -->
<div class="main">

    <h1 id="commName" class="dash-title">Loading...</h1>
    <p id="commDesc" class="user-tag"></p>

    <!-- ============================
         PANEL: COMMUNITY HOME
    ============================ -->
    <div id="panel-community" class="panel">

        <!-- COMMUNITY SETTINGS -->
        <div class="section">
            <h2>Community Settings</h2>
            <div class="divider"></div>

            <input id="editName" class="dash-input" placeholder="Community Name">
            <input id="editDesc" class="dash-input" placeholder="Description">

            <button class="btn-primary" onclick="saveCommunity()">Save Changes</button>
        </div>

        <!-- ============================
             DEPARTMENTS
        ============================ -->
        <div class="section">
            <h2>Departments</h2>
            <div class="divider"></div>

            <button class="btn-small" onclick="openModal('deptModal')">+ Add Department</button>

            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="deptList"></tbody>
            </table>
        </div>

        <!-- ============================
             RANKS (COLLAPSIBLE)
        ============================ -->
        <div class="section">
            <h2>Ranks</h2>
            <div class="divider"></div>

            <button class="btn-small" onclick="openModal('rankModal')">+ Add Rank</button>

            <details open>
                <summary>View All Ranks</summary>
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Department</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rankList"></tbody>
                </table>
            </details>
        </div>

        <!-- ============================
             MEMBERS
        ============================ -->
        <div class="section">
            <h2>Members</h2>
            <div class="divider"></div>

            <div style="display:flex; gap:10px;">
                <input id="memberSearch" class="dash-input" placeholder="Search user email...">
                <button class="btn-small" onclick="searchUser()">Search</button>
            </div>

            <div id="memberSearchResult" style="margin-top:15px;"></div>

            <h3 style="margin-top:25px; color:var(--accent);">Current Members</h3>

            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Permissions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="memberList"></tbody>
            </table>
        </div>

        <!-- ============================
             DANGER ZONE
        ============================ -->
        <div class="section">
            <h2 style="color:var(--danger)">Danger Zone</h2>
            <div class="divider"></div>

            <button class="danger-btn" onclick="deleteCommunity()">Delete Community</button>
        </div>

    </div> <!-- END panel-community -->


    <!-- ============================
         PANEL: CLAIM PERMISSION KEY
    ============================ -->
    <div id="panel-claim" class="panel" style="display:none;">
        <div class="section">
            <h2>Enter Access Key</h2>
            <div class="divider"></div>

            <p style="opacity:0.8;">
                Enter a permission key provided by your community staff.
            </p>

            <input id="claimKeyInput" class="dash-input" placeholder="e.g. LEO-A4F92C">

            <button class="btn-primary" onclick="claimKey()">Submit Key</button>

            <p id="claimKeyResult" style="margin-top:12px;"></p>
        </div>
    </div>

// PERMISSION KEYS
    
<div id="panel-keys" class="panel" style="display:none;">
  <div class="section">

    <h2>Permission Keys</h2>
    <div class="divider"></div>

    <table>
      <thead>
        <tr>
          <th>Role</th>
          <th>Key</th>
        </tr>
      </thead>
      <tbody id="keyList"></tbody>
    </table>

  </div>
</div>

    
    <!-- ============================
         PANEL: PLACEHOLDERS
         (Actual pages exist separately)
    ============================ -->
    <div id="panel-supervisor" class="panel" style="display:none;">
        <div class="section"><p>Supervisor Panel is a separate page.</p></div>
    </div>

    <div id="panel-admin" class="panel" style="display:none;">
        <div class="section"><p>Admin Panel is a separate page.</p></div>
    </div>

    <div id="panel-dispatch" class="panel" style="display:none;">
        <div class="section">
            <p>Click below to open Dispatch Console:</p>
            <button class="btn-primary" onclick="window.location.href='dispatch.html'">Open Dispatch</button>
        </div>
    </div>

    <div id="panel-mdt" class="panel" style="display:none;">
        <div class="section">
            <p>Click below to open LEO MDT:</p>
            <button class="btn-primary" onclick="window.location.href='mdt.html'">Open MDT</button>
        </div>
    </div>

    <div id="panel-fire" class="panel" style="display:none;">
        <div class="section">
            <p>Click below to open Fire / EMS MDT:</p>
            <button class="btn-primary" onclick="window.location.href='fire.html'">Open Fire/EMS Panel</button>
        </div>
    </div>


</div> <!-- END MAIN -->


<!-- ============================
     MODALS
============================ -->
<div id="deptModal" class="modal-bg">
    <div class="modal">
        <h2>Add Department</h2>

        <input id="newDeptName" placeholder="Department Name">

        <!-- Type is now a select matching backend enums (leo, fire, ems, dispatch) -->
        <select id="newDeptType">
            <option value="leo">Law Enforcement (LEO)</option>
            <option value="fire">Fire</option>
            <option value="ems">EMS</option>
            <option value="dispatch">Dispatch</option>
        </select>

        <button class="btn-primary" onclick="addDepartment()">Add</button>
        <button class="close-btn" onclick="closeModal('deptModal')">Cancel</button>
    </div>
</div>

<div id="rankModal" class="modal-bg">
    <div class="modal">
        <h2>Add Rank</h2>

        <input id="newRankName" placeholder="Rank Name">

        <!-- Populated dynamically with departments -->
        <select id="newRankDept">
            <option value="">Global / All Departments</option>
        </select>
        <small style="display:block; opacity:0.7;">Optional â€“ link this rank to a specific department.</small>

        <button class="btn-primary" onclick="addRank()">Add</button>
        <button class="close-btn" onclick="closeModal('rankModal')">Cancel</button>
    </div>
</div>

<script>
/* ============================================================
   INIT / AUTH CHECK
============================================================ */

const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user") || "null");
const communityId = localStorage.getItem("selectedCommunity");

if (!token || !communityId || !user) {
    window.location.href = "dashboard.html";
}

const API = "https://opslink-api.onrender.com";

// Caches for mapping IDs -> names
let departmentsCache = [];
let ranksCache = [];


/* ============================================================
   PANEL SWITCHING (FULLY UPDATED)
============================================================ */
document.querySelectorAll(".nav-item").forEach(item => {
    item.addEventListener("click", () => {

        // Remove active class from all nav items
        document.querySelectorAll(".nav-item").forEach(i =>
            i.classList.remove("active")
        );
        item.classList.add("active");

        // Get panel identifier
        const target = item.dataset.panel;

        // Hide all panels
        document.querySelectorAll(".panel").forEach(p => {
            p.style.display = "none";
        });

        // Show selected panel
        const panel = document.getElementById(target);
        if (panel) panel.style.display = "block";

        // ðŸ”¥ PANEL-SPECIFIC LOADERS
        switch (target) {
            case "panel-community":
                loadCommunity();
                break;

            case "panel-keys":
                loadPermissionKeys();
                break;

            case "panel-dispatch":
                // Reserved â€“ opens external page
                break;

            case "panel-supervisor":
                // Reserved for future data loads
                break;

            case "panel-admin":
                // Reserved for admin loads
                break;

            case "panel-mdt":
                // handled by redirect button
                break;

            case "panel-fire":
                // handled by redirect button
                break;
        }
    });
});



/* ============================================================
   PERMISSION LOCKS
============================================================ */
function applyPermissionLocks(member) {
    const role = member?.role || "member";
    const permissions = member?.permissions || [];

    function hide(selector) {
        document.querySelectorAll(selector).forEach(el => {
            el.style.display = "none";
        });
    }

    // OWNER = full access
    if (role === "owner") return;

    // Admin
    if (!permissions.includes("admin")) {
        hide("#adminNav");
        hide("#permKeyNav");
        hide('[data-panel="panel-admin"]');
        hide('[data-panel="panel-keys"]');
    }

    // Dispatch
    if (!permissions.includes("dispatch") && !permissions.includes("admin")) {
        hide("#dispatchNav");
        hide('[data-panel="panel-dispatch"]');
    }

    // Supervisor
    if (!permissions.includes("supervisor") && !permissions.includes("admin")) {
        hide("#supervisorNav");
        hide('[data-panel="panel-supervisor"]');
    }

    // LEO MDT
    if (!permissions.includes("leo") && !permissions.includes("admin")) {
        hide("#mdtNav");
        hide('[data-panel="panel-mdt"]');
    }

    // Fire/EMS
    if (!permissions.includes("fire") && !permissions.includes("admin")) {
        hide("#fireNav");
        hide('[data-panel="panel-fire"]');
    }
}


/* ============================================================
   LOAD COMMUNITY DATA
============================================================ */
async function loadCommunity() {
    try {
        const res = await fetch(`${API}/community/${communityId}`, {
            headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json();

        if (!res.ok) {
            alert(data.message || "Failed to load community.");
            return;
        }

        // Which member is logged in?
        const member = (data.members || []).find(
            m => m.userId === user._id || m.userId?._id === user._id
        );

        // Save locally
        localStorage.setItem("communityRole", member?.role || "member");
        localStorage.setItem("permissions", JSON.stringify(member?.permissions || []));

        // Lock UI based on permissions
        applyPermissionLocks(member);

        // Fill UI
        document.getElementById("commName").innerText = data.name || "Unnamed Community";
        document.getElementById("commDesc").innerText = data.description || "";
        document.getElementById("editName").value = data.name || "";
        document.getElementById("editDesc").value = data.description || "";

        // Load related lists in order so caches exist
        await loadDepartments();
        await loadRanks();
        await loadMembers();
    } catch (err) {
        console.error("loadCommunity error:", err);
        alert("Error loading community.");
    }
}


/* ============================================================
   COMMUNITY SETTINGS
============================================================ */
async function saveCommunity() {
    const name = document.getElementById("editName").value.trim();
    const description = document.getElementById("editDesc").value.trim();

    try {
        const res = await fetch(`${API}/community/update/${communityId}`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name, description })
        });

        const data = await res.json();

        if (!res.ok) {
            alert(data.message || "Failed to update community.");
            return;
        }

        alert("Community updated!");
        loadCommunity();
    } catch (err) {
        console.error("saveCommunity error:", err);
        alert("Error saving community.");
    }
}


/* ============================================================
   DEPARTMENTS
============================================================ */
async function loadDepartments() {
    try {
        const res = await fetch(`${API}/departments/${communityId}`, {
            headers: { "Authorization": "Bearer " + token }
        });

        const deps = await res.json();

        if (!res.ok) {
            alert(deps.message || "Failed to load departments.");
            return;
        }

        departmentsCache = deps || [];

        const list = document.getElementById("deptList");
        list.innerHTML = "";

        departmentsCache.forEach(d => {
            const typeLabel = (d.type || "N/A").toString().toUpperCase();
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${d.name}</td>
                <td>${typeLabel}</td>
                <td>
                    <button class="btn-small danger-btn" onclick="deleteDepartment('${d._id}')">Delete</button>
                </td>
            `;
            list.appendChild(row);
        });

        // Also populate rank department select
        const rankDeptSelect = document.getElementById("newRankDept");
        if (rankDeptSelect) {
            rankDeptSelect.innerHTML = `<option value="">Global / All Departments</option>`;
            departmentsCache.forEach(d => {
                const opt = document.createElement("option");
                opt.value = d._id;
                opt.textContent = `${d.name} (${(d.type || "").toUpperCase()})`;
                rankDeptSelect.appendChild(opt);
            });
        }
    } catch (err) {
        console.error("loadDepartments error:", err);
        alert("Error loading departments.");
    }
}

async function addDepartment() {
    const name = document.getElementById("newDeptName").value.trim();
    const type = document.getElementById("newDeptType").value; // already valid enum

    if (!name) {
        alert("Enter a department name.");
        return;
    }

    try {
        const res = await fetch(`${API}/departments/${communityId}/create`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name, type })
        });

        const data = await res.json();

        if (!res.ok) {
            alert(data.message || "Error creating department.");
            return;
        }

        document.getElementById("newDeptName").value = "";
        closeModal("deptModal");
        loadDepartments();
    } catch (err) {
        console.error("addDepartment error:", err);
        alert("Error creating department.");
    }
}

async function deleteDepartment(id) {
    if (!confirm("Delete this department?")) return;

    try {
        const res = await fetch(`${API}/departments/delete/${id}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
            alert(data.message || "Failed to delete department.");
            return;
        }

        loadDepartments();
    } catch (err) {
        console.error("deleteDepartment error:", err);
        alert("Error deleting department.");
    }
}


/* ============================================================
   RANKS
============================================================ */
async function loadRanks() {
    try {
        const res = await fetch(`${API}/community/${communityId}/ranks`, {
            headers: { "Authorization": "Bearer " + token }
        });

        const ranks = await res.json();

        if (!res.ok) {
            alert(ranks.message || "Failed to load ranks.");
            return;
        }

        ranksCache = ranks || [];

        const list = document.getElementById("rankList");
        list.innerHTML = "";

        ranksCache.forEach(r => {
            const deptId = r.departmentId?._id || r.departmentId || "";
            let deptLabel = "Global / Any";

            if (deptId) {
                const found = departmentsCache.find(d => d._id === deptId);
                deptLabel = found ? found.name : deptId;
            }

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${r.name}</td>
                <td>${deptLabel}</td>
                <td>
                    <button class="btn-small danger-btn" onclick="deleteRank('${r._id}')">Delete</button>
                </td>
            `;
            list.appendChild(row);
        });
    } catch (err) {
        console.error("loadRanks error:", err);
        alert("Error loading ranks.");
    }
}

async function addRank() {
    const name = document.getElementById("newRankName").value.trim();
    const departmentId = document.getElementById("newRankDept").value || null;

    if (!name) {
        alert("Enter a rank name.");
        return;
    }

    try {
        const res = await fetch(`${API}/community/${communityId}/ranks/create`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name, departmentId })
        });

        const data = await res.json();

        if (!res.ok) {
            alert(data.message || "Failed to create rank.");
            return;
        }

        document.getElementById("newRankName").value = "";
        document.getElementById("newRankDept").value = "";
        closeModal("rankModal");
        loadRanks();
    } catch (err) {
        console.error("addRank error:", err);
        alert("Error creating rank.");
    }
}

async function deleteRank(id) {
    if (!confirm("Delete this rank?")) return;

    try {
        const res = await fetch(`${API}/community/${communityId}/ranks/delete/${id}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
            alert(data.message || "Failed to delete rank.");
            return;
        }

        loadRanks();
    } catch (err) {
        console.error("deleteRank error:", err);
        alert("Error deleting rank.");
    }
}


/* ============================================================
   MEMBERS
============================================================ */
async function loadMembers() {
    try {
        const res = await fetch(`${API}/community/${communityId}/members`, {
            headers: { "Authorization": "Bearer " + token }
        });

        const members = await res.json();

        if (!res.ok) {
            alert(members.message || "Failed to load members.");
            return;
        }

        const list = document.getElementById("memberList");
        list.innerHTML = "";

        members.forEach(m => {
            const email = m.userEmail || m.email || m.user?.email || "Unknown";
            const permsArr = m.permissions || [];
            const permsHtml = permsArr.length
                ? permsArr.map(p => `<span class="pill">${p}</span>`).join(" ")
                : '<span style="opacity:0.7;">none</span>';

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${email}</td>
                <td>${m.role}</td>
                <td>${permsHtml}</td>
                <td>
                    <button class="btn-small danger-btn" onclick="removeMember('${m.userId}')">Remove</button>
                </td>
            `;
            list.appendChild(row);
        });
    } catch (err) {
        console.error("loadMembers error:", err);
        alert("Error loading members.");
    }
}

async function searchUser() {
    const email = document.getElementById("memberSearch").value.trim();
    const resultBox = document.getElementById("memberSearchResult");

    if (!email) {
        resultBox.innerText = "Enter an email to search.";
        resultBox.style.color = "red";
        return;
    }

    try {
        const res = await fetch(`${API}/auth/find`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ email })
        });

        const data = await res.json();

        if (!res.ok) {
            resultBox.innerText = data.message || "User not found.";
            resultBox.style.color = "red";
            return;
        }

        resultBox.style.color = "#fff";
        resultBox.innerHTML = `
            <p>User: ${data.email}</p>
            <button class="btn-small" onclick="addMember('${data._id}')">Add to Community</button>
        `;
    } catch (err) {
        console.error("searchUser error:", err);
        resultBox.innerText = "Error searching user.";
        resultBox.style.color = "red";
    }
}

async function addMember(id) {
    try {
        const res = await fetch(`${API}/community/${communityId}/addUser`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ userId: id })
        });

        const data = await res.json();

        if (!res.ok) {
            alert(data.message || "Failed to add member.");
            return;
        }

        alert("User added!");
        document.getElementById("memberSearchResult").innerText = "";
        loadMembers();
    } catch (err) {
        console.error("addMember error:", err);
        alert("Error adding member.");
    }
}

async function removeMember(userId) {
    if (!confirm("Remove this member?")) return;

    try {
        const res = await fetch(`${API}/community/${communityId}/removeUser/${userId}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
            alert(data.message || "Failed to remove member.");
            return;
        }

        loadMembers();
    } catch (err) {
        console.error("removeMember error:", err);
        alert("Error removing member.");
    }
}


/* ============================================================
   CLAIM PERMISSION KEY
============================================================ */
async function claimKey() {
    const key = document.getElementById("claimKeyInput").value.trim();
    const resBox = document.getElementById("claimKeyResult");

    if (!key) {
        resBox.innerText = "Enter a key.";
        resBox.style.color = "red";
        return;
    }

    try {
        const res = await fetch(`${API}/community/permission/claim`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ communityId, key })
        });

        const data = await res.json();

        if (!res.ok) {
            resBox.innerText = data.message || "Invalid key.";
            resBox.style.color = "red";
            return;
        }

        resBox.innerText = `Access granted: ${data.granted?.toUpperCase?.() || data.granted}`;
        resBox.style.color = "lime";

        loadCommunity();
    } catch (err) {
        console.error("claimKey error:", err);
        resBox.innerText = "Error claiming key.";
        resBox.style.color = "red";
    }
}

// LOAD PERMISSION KEYS

    async function loadPermissionKeys() {
  try {
    const res = await fetch(`${API}/community/${communityId}`, {
      headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    if (!res.ok) return alert(data.message || "Failed to load keys.");

    const list = document.getElementById("keyList");
    list.innerHTML = "";

    Object.entries(data.permissionKeys || {}).forEach(([role, key]) => {
      list.innerHTML += `
        <tr>
          <td>${role.toUpperCase()}</td>
          <td>${key || "<i style='opacity:.7;'>None assigned</i>"}</td>
        </tr>
      `;
    });

  } catch (err) {
    console.error("loadPermissionKeys error:", err);
    alert("Error loading permission keys.");
  }
}

    
/* ============================================================
   MODALS
============================================================ */
function openModal(id) {
    const el = document.getElementById(id);
    if (el) el.style.display = "flex";
}

function closeModal(id) {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
}


/* ============================================================
   DELETE COMMUNITY
============================================================ */
async function deleteCommunity() {
    if (!confirm("This action cannot be undone. Delete community?"))
        return;

    try {
        const res = await fetch(`${API}/community/delete/${communityId}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
            alert(data.message || "Failed to delete community.");
            return;
        }

        localStorage.removeItem("selectedCommunity");
        alert("Community deleted.");
        window.location.href = "dashboard.html";
    } catch (err) {
        console.error("deleteCommunity error:", err);
        alert("Error deleting community.");
    }
}


/* ============================================================
   LOGOUT
============================================================ */
function logout() {
    localStorage.clear();
    window.location.href = "login.html";
}


/* ============================================================
   LOAD EVERYTHING
============================================================ */
loadCommunity();
</script>
</body>
</html>
