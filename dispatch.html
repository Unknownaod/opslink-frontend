<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OpsLinkCAD Dispatch Console</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ================================================================
   OPSLINKCAD â€“ FULL DISPATCH CONSOLE (ALL FEATURES)
   SonoranCAD Style â€” Dark Blue Accent
   ================================================================ */
:root {
  --bg-main:#0c1118;--bg-elevated:#131a24;--bg-panel:#161e29;
  --border:#1f2a38;--accent:#4e8cff;--accent-hover:#73a5ff;
  --danger:#ff3b3b;--warning:#ffcc00;--text:#e8ecf5;--text-soft:#9aa7b9;
}
body{margin:0;background:var(--bg-main);color:var(--text);font-family:Segoe UI, sans-serif;overflow:hidden;height:100vh;}
#topnav{height:55px;background:var(--bg-elevated);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;font-size:20px;font-weight:bold;color:var(--accent);justify-content:space-between;}
#layout{display:grid;grid-template-columns:340px 1fr 380px;height:calc(100vh - 55px);}
#call-create,#call-details,#unit-board{overflow-y:auto;padding:20px;}
#call-create{background:var(--bg-elevated);border-right:1px solid var(--border);}
#unit-board{background:var(--bg-elevated);border-left:1px solid var(--border);}
#call-board{padding:20px;overflow-y:auto;}
h2{margin-top:0;color:var(--accent);}
label{display:block;margin-top:12px;font-size:14px;}
input,select,textarea{
  width:100%;padding:10px;margin-top:5px;background:var(--bg-panel);
  border:1px solid var(--border);border-radius:6px;color:var(--text);
}
textarea{resize:vertical;height:80px;}
.btn{margin-top:15px;width:100%;padding:12px;background:var(--accent);border:none;color:white;border-radius:6px;cursor:pointer;font-size:15px;}
.btn:hover{background:var(--accent-hover);}
.small-btn{padding:8px 12px;background:var(--bg-elevated);border:1px solid var(--border);color:var(--text);border-radius:6px;cursor:pointer;font-size:13px;margin-right:4px;}
.small-btn:hover{background:var(--accent);}

/* CALL CARDS */
.call-card{background:var(--bg-panel);padding:15px;border:1px solid var(--border);border-radius:6px;margin-bottom:15px;}
.call-card h3{margin:0 0 10px 0;color:var(--accent);}
.call-actions{display:flex;gap:6px;margin-top:12px;}

/* UNIT CARDS */
.unit-card{background:var(--bg-panel);border:1px solid var(--border);margin-bottom:12px;padding:12px;border-radius:6px;}
.unit-title{font-size:17px;color:var(--accent);}
.status{font-size:13px;color:var(--text-soft);}
.panic{background:var(--danger) !important;border-color:#ff7474 !important;}

/* CALL DETAILS PANEL (Slide-in) */
#call-details {
  position:fixed;right:-420px;top:55px;width:420px;height:calc(100vh - 55px);
  background:var(--bg-panel);border-left:1px solid var(--border);
  transition:0.3s;padding:20px;overflow-y:auto;z-index:20;
}
#call-details.open{right:0;}
.detail-row{margin-bottom:12px;}
.detail-row label{font-size:13px;margin-bottom:4px;}
.detail-value{background:var(--bg-elevated);padding:8px;border-radius:6px;border:1px solid var(--border);}

/* PANIC BANNER */
#panic-banner{display:none;background:var(--danger);padding:12px;text-align:center;font-weight:bold;animation:flash 0.6s infinite alternate;}
@keyframes flash{from{opacity:1;}to{opacity:0.4;}}

/* NOTES SECTION */
.note{background:var(--bg-elevated);padding:10px;border-radius:6px;border:1px solid var(--border);margin-bottom:8px;}
</style>
</head>
<body>

<div id="panic-banner">ðŸš¨ PANIC BUTTON ACTIVATED â€” UNIT NEEDS ASSISTANCE NOW!</div>

<div id="topnav">
  <div>OpsLinkCAD Dispatch</div>
  <div class="right">Real-Time Dispatch Console</div>
</div>

<div id="layout">

  <!-- LEFT â€” CALL CREATION -->
  <div id="call-create">
    <h2>Create Call</h2>
    <label>Call Type</label><input id="callType" />
    <label>Priority</label>
    <select id="priority">
      <option value="1">Priority 1 - Emergency</option>
      <option value="2">Priority 2 - Urgent</option>
      <option value="3" selected>Priority 3 - Routine</option>
    </select>
    <label>Subtype</label><input id="subtype" />
    <label>Location</label><input id="location" />
    <label>Cross Streets</label><input id="cross" />
    <label>Description</label><textarea id="description"></textarea>
    <label>Caller Name</label><input id="callerName" />
    <label>Caller Phone</label><input id="callerPhone" />
    <button class="btn" onclick="createCall()">Create Call</button>
  </div>

  <!-- MIDDLE â€” CALL LIST -->
  <div id="call-board">
    <h2>Active Calls</h2>
    <div id="callsContainer"></div>
  </div>

  <!-- RIGHT â€” UNIT BOARD -->
  <div id="unit-board">
    <h2>Units</h2>
    <div id="unitsContainer"></div>
  </div>
</div>

<!-- CALL DETAILS SLIDE-IN PANEL -->
<div id="call-details">
  <h2 id="cd-title">Call Details</h2>
  <div id="cd-content"></div>

  <h3 style="margin-top:25px;">Notes</h3>
  <div id="notesContainer"></div>

  <textarea id="noteInput" placeholder="Add note..."></textarea>
  <button class="btn" onclick="addNote()">Add Note</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// ======================================================
// CONFIG
// ======================================================
const API = "https://opslink-api.onrender.com";
const socket = io(API);

// LOAD PERMISSIONS + COMMUNITY ID
const permissions = JSON.parse(localStorage.getItem("permissions")) || [];
const communityId = localStorage.getItem("selectedCommunity");

// LOCK DISPATCH PAGE
if (!permissions.includes("dispatch")) {
    alert("You do not have access to the Dispatch Console.");
    window.location.href = "community.html";
}

// VARIABLES
let selectedCall = null;


// ======================================================
// LOAD CALLS
// ======================================================
async function loadCalls() {
  const res = await fetch(`${API}/calls/${communityId}`);
  const calls = await res.json();

  const container = document.getElementById("callsContainer");
  container.innerHTML = "";

  calls.forEach(call => {
    const div = document.createElement("div");
    div.className = "call-card";
    div.innerHTML = `
      <h3>Call #${call.callNumber}</h3>
      <p><b>Type:</b> ${call.type}</p>
      <p><b>Priority:</b> ${call.priority}</p>
      <p><b>Location:</b> ${call.location}</p>
      <p><b>Caller:</b> ${call.callerName || "Unknown"} (${call.callerPhone || "N/A"})</p>

      <div class="call-actions">
        <button class="small-btn" onclick="openCall('${call._id}')">Open</button>
        <button class="small-btn" onclick="closeCall('${call._id}')">Close</button>
      </div>
    `;
    container.appendChild(div);
  });
}

// ======================================================
// LOAD UNITS
// ======================================================
async function loadUnits() {
  const res = await fetch(`${API}/units/${communityId}`);
  const units = await res.json();

  const container = document.getElementById("unitsContainer");
  container.innerHTML = "";

  units.forEach(u => {
    const div = document.createElement("div");
    div.className = "unit-card";
    if (u.status === "PANIC") div.classList.add("panic");
    div.innerHTML = `
      <div class="unit-title">${u.callsign}</div>
      <div class="status">Status: ${u.status}</div>
      <div class="status">Dept: ${u.departmentName}</div>
      <button class="small-btn" onclick="attachToCallFromUnit('${u._id}')">Attach</button>
      <button class="small-btn" onclick="force108('${u._id}')">Force 10-8</button>
      <button class="small-btn" onclick="force107('${u._id}')">Force 10-7</button>
    `;
    container.appendChild(div);
  });
}

// ======================================================
// CREATE CALL
// ======================================================
async function createCall() {
  const body = {
    communityId,
    type:callType.value,priority:priority.value,subtype:subtype.value,
    location:location.value,cross:cross.value,description:description.value,
    callerName:callerName.value,callerPhone:callerPhone.value
  };

  await fetch(`${API}/calls/create`,{
    method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)
  });

  socket.emit("call:update",{});
  loadCalls();
}

// ======================================================
// CLOSE CALL
// ======================================================
async function closeCall(id){
  await fetch(`${API}/calls/update/${id}`,{
    method:"PUT",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({status:"Closed"})
  });
  socket.emit("call:update",{});
  loadCalls();
  closeDetails();
}

// ======================================================
// OPEN CALL DETAILS
// ======================================================
async function openCall(id){
  selectedCall=id;
  const res=await fetch(`${API}/calls/${communityId}`);
  const calls=await res.json();
  const call=calls.find(c=>c._id===id);

  document.getElementById("cd-title").innerText=`Call #${call.callNumber}`;
  document.getElementById("cd-content").innerHTML=`
    <div class="detail-row"><label>Type</label><div class="detail-value">${call.type}</div></div>
    <div class="detail-row"><label>Priority</label><div class="detail-value">${call.priority}</div></div>
    <div class="detail-row"><label>Location</label><div class="detail-value">${call.location}</div></div>
    <div class="detail-row"><label>Description</label><div class="detail-value">${call.description}</div></div>
    <button class="btn" onclick="attachUnit()">Attach Unit</button>
    <button class="btn" onclick="detachUnit()">Detach Unit</button>
  `;

  loadNotes(id);

  document.getElementById("call-details").classList.add("open");
}

function closeDetails(){
  document.getElementById("call-details").classList.remove("open");
}

// ======================================================
// NOTES
// ======================================================
async function loadNotes(id){
  const res=await fetch(`${API}/calls/${communityId}`);
  const calls=await res.json();
  const call=calls.find(c=>c._id===id);

  const box=document.getElementById("notesContainer");
  box.innerHTML="";

  call.notes.forEach(n=>{
    const d=document.createElement("div");
    d.className="note";
    d.innerText=`${n.text}`;
    box.appendChild(d);
  });
}

async function addNote(){
  const text=document.getElementById("noteInput").value;
  if(!text) return;

  await fetch(`${API}/calls/addNote/${selectedCall}`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({userId:"dispatcher",text})
  });

  document.getElementById("noteInput").value="";
  socket.emit("call:update",{});
  loadNotes(selectedCall);
}

// ======================================================
// ATTACH / DETACH
// ======================================================
async function attachUnit(){
  alert("Attach unit UI upgrading next build.");
}
async function detachUnit(){
  alert("Detach unit UI upgrading next build.");
}
async function attachToCallFromUnit(id){
  alert("Full attach menu coming next build.");
}

// ======================================================
// FORCE ACTIONS
// ======================================================
async function force108(unitId){
  await fetch(`${API}/units/status/${unitId}`,{
    method:"PUT",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({status:"10-8"})
  });
  socket.emit("unit:status",{});
}
async function force107(unitId){
  await fetch(`${API}/units/status/${unitId}`,{
    method:"PUT",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({status:"10-7"})
  });
  socket.emit("unit:status",{});
}

// ======================================================
// SOCKET EVENTS
// ======================================================
socket.on("unit:status",()=>loadUnits());
socket.on("call:update",()=>{
  loadCalls();
  if(selectedCall) openCall(selectedCall);
});
socket.on("panic:button",(data)=>{
  document.getElementById("panic-banner").style.display="block";
  loadUnits();
});

// INITIAL LOAD
loadCalls();
loadUnits();
</script>
</body>
</html>
