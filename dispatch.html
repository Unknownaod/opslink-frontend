<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dispatch Console â€“ OpsLinkCAD</title>

<style>
/* ============================================================
   OPSLINK DISPATCH CONSOLE â€“ DARK THEME
   ============================================================ */

:root {
    --bg-main: #0f141a;
    --bg-panel: #161b22;
    --bg-sidebar: #0d1117;
    --border: #1e2630;
    --accent: #4ea1ff;
    --danger: #d9534f;
    --text: #c9d1d9;
    --text-dim: #8894a6;
}

body {
    margin: 0;
    background: var(--bg-main);
    color: var(--text);
    font-family: "Segoe UI", sans-serif;
}

/* SIDEBAR */
.sidebar {
    position: fixed;
    top: 0; left: 0;
    width: 240px;
    height: 100vh;
    background: var(--bg-sidebar);
    border-right: 1px solid #161b22;
    padding: 20px;
}
.sidebar .logo {
    font-size: 26px;
    font-weight: bold;
    margin-bottom: 32px;
}
.sidebar a {
    display: block;
    padding: 12px;
    margin-bottom: 8px;
    text-decoration: none;
    color: var(--text);
    border-radius: 6px;
    transition: .15s;
}
.sidebar a:hover,
.sidebar a.active {
    background: #1a222e;
    color: var(--accent);
}

/* MAIN CONTENT */
.main {
    margin-left: 260px;
    padding: 25px;
}
h1 { margin-top: 0; }

/* GRID SPLIT */
.grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 22px;
}

/* CARDS */
.card {
    background: var(--bg-panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 18px;
}
.card h2 { margin-top: 0; color: var(--accent); }

/* TABLES */
table {
    width: 100%;
    border-collapse: collapse;
}
th {
    padding: 8px;
    text-align: left;
    background: #1e2630;
}
td {
    padding: 8px;
    border-bottom: 1px solid #1f2933;
}

/* BUTTONS */
button {
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}
.btn-primary {
    background: var(--accent);
    color: #fff;
}
.btn-danger {
    background: var(--danger);
    color: #fff;
}
.btn-dark {
    background: #1f2630;
    border: 1px solid var(--accent);
    color: var(--accent);
}
.btn-small { padding: 5px 9px; font-size: 13px; }

/* CALL STATUS COLORS */
.call-pending { color: #ffb454; }
.call-active { color: var(--accent); }
.call-closed { color: #6b7280; }

/* UNIT STATUS BADGES */
.status-pill {
    padding: 4px 8px;
    border-radius: 5px;
    font-size: 12px;
}
.status-108 { background: #2ecc71; color: #000; }
.status-107 { background: #e74c3c; color: #fff; }
.status-busy { background: #f1c40f; color: #000; }
.status-panic {
    background: #ff0033;
    color: #fff;
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 #ff0033; }
    50% { box-shadow: 0 0 15px #ff0033; }
    100% { box-shadow: 0 0 0 #ff0033; }
}

/* MODALS */
.modal-bg {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    display:none;
    justify-content:center;
    align-items:center;
    background: rgba(0,0,0,.75);
}
.modal {
    background: var(--bg-panel);
    width: 420px;
    padding: 25px;
    border-radius: 8px;
    border: 1px solid var(--accent);
}
.modal input,
.modal textarea {
    width:100%;
    padding:10px;
    background:#0f141a;
    border: 1px solid #333;
    border-radius: 6px;
    color: #fff;
    margin-bottom:10px;
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="logo">OpsLink<span style="color:#4ea1ff;">CAD</span></div>
    <a href="dashboard.html">Dashboard</a>
    <a href="community.html">Community</a>
    <a class="active">Dispatch Console</a>
    <a onclick="logout()">Logout</a>
</div>

<!-- MAIN -->
<div class="main">
    <h1>Dispatch Console</h1>
    <p id="connectionStatus" style="opacity:.6;margin-bottom:12px;">Connecting...</p>

    <div class="grid">

        <!-- CALLS -->
        <div class="card">
            <h2>Active Calls</h2>
            <button class="btn-primary" onclick="openNewCallModal()">+ New Call</button>

            <table style="margin-top:12px;">
                <thead><tr>
                    <th>Title</th><th>Status</th><th>Units</th><th></th>
                </tr></thead>
                <tbody id="callList"></tbody>
            </table>
        </div>

        <!-- UNITS -->
        <div class="card">
            <h2>Units</h2>
            <table>
                <thead><tr>
                    <th>Callsign</th><th>Status</th><th>Name</th><th>Type</th>
                </tr></thead>
                <tbody id="unitList"></tbody>
            </table>
        </div>

        <!-- BOLO -->
        <div class="card" style="grid-column: 1 / span 2;">
            <h2>BOLOs</h2>
            <button class="btn-primary" onclick="openBoloModal()">+ Create BOLO</button>
            <div id="boloList" style="margin-top:12px;"></div>
        </div>

    </div>
</div>

<!-- CALL MODAL -->
<div id="newCallModal" class="modal-bg">
<div class="modal">
    <h2>Create Call</h2>
    <input id="callTitle" placeholder="Call Title">
    <textarea id="callNotes" placeholder="Notes..."></textarea>
    <input id="callLocation" placeholder="Location">
    <button class="btn-primary" onclick="createCall()">Create</button>
    <button class="btn-danger" onclick="closeNewCallModal()">Cancel</button>
</div>
</div>

<!-- BOLO MODAL -->
<div id="boloModal" class="modal-bg">
<div class="modal">
    <h2>Create BOLO</h2>
    <input id="boloType" placeholder="Vehicle / Person">
    <input id="boloPlate" placeholder="Plate (optional)">
    <textarea id="boloDesc" placeholder="Description"></textarea>
    <button class="btn-primary" onclick="createBOLO()">Create</button>
    <button class="btn-danger" onclick="closeBoloModal()">Cancel</button>
</div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
/* ============================================================
   CONFIG
============================================================ */
const API = "https://opslink-api.onrender.com";
const token = localStorage.getItem("token");
const communityId = localStorage.getItem("selectedCommunity");
const permissions = JSON.parse(localStorage.getItem("permissions")) || [];
const role = localStorage.getItem("communityRole") || "member";

if (!permissions.includes("dispatch") && !permissions.includes("admin") && role !== "owner") {
    alert("Unauthorized");
    location.href = "community.html";
}

/* SOCKET */
const socket = io(API, { auth:{ token }});
socket.on("connect", () => connectionStatus.innerText = "Connected âœ“");
socket.on("unit:status", loadUnits);
socket.on("unit:location", loadUnits);
socket.on("unit:panic", d => alert("ðŸš¨ PANIC by " + d.callsign));
socket.on("unit:forceOffline", loadUnits);
socket.on("call:update", loadCalls);


/* ============================================================
   CALLS
============================================================ */
async function loadCalls() {
    const res = await fetch(`${API}/calls/${communityId}`, {
        headers:{ Authorization:"Bearer " + token }
    });

    const calls = await res.json();
    callList.innerHTML = "";

    calls.forEach(call => {
        const units = call.units?.map(u => u.callsign).join(", ") || "None";

        callList.innerHTML += `
        <tr>
            <td>${call.title}</td>
            <td class="call-${call.status}">${call.status.toUpperCase()}</td>
            <td>${units}</td>
            <td><button class="btn-dark btn-small" onclick='manageCall("${call._id}")'>Manage</button></td>
        </tr>`;
    });
}

async function createCall() {
    await fetch(`${API}/calls/create`, {
        method:"POST",
        headers:{ Authorization:"Bearer "+token, "Content-Type":"application/json" },
        body:JSON.stringify({
            communityId,
            title:callTitle.value,
            notes:callNotes.value,
            location:callLocation.value
        })
    });

    closeNewCallModal();
    socket.emit("call:update");
    loadCalls();
}

async function manageCall(id) {
    const choice = prompt("1 = ACTIVE\n2 = CLOSED");
    if (choice === "1") updateCallStatus(id,"active");
    if (choice === "2") updateCallStatus(id,"closed");
}

async function updateCallStatus(id,status) {
    await fetch(`${API}/calls/${id}/status`, {
        method:"POST",
        headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},
        body:JSON.stringify({status})
    });
    socket.emit("call:update");
    loadCalls();
}


/* ============================================================
   UNITS
============================================================ */
async function loadUnits() {
    const res = await fetch(`${API}/units/${communityId}`, {
        headers:{ Authorization:"Bearer "+token }
    });
    const units = await res.json();
    unitList.innerHTML = "";

    units.forEach(u => {
        const st = u.status === "10-8" ? "status-108"
                 : u.status === "panic" ? "status-panic"
                 : u.status === "10-7" ? "status-107"
                 : "status-busy";

        unitList.innerHTML += `
        <tr>
            <td>${u.callsign}</td>
            <td><span class="status-pill ${st}">${u.status}</span></td>
            <td>${u.name}</td>
            <td>${u.type}</td>
        </tr>`;
    });
}


/* ============================================================
   BOLO SYSTEM
============================================================ */
async function loadBOLOs() {
    const res = await fetch(`${API}/bolos/${communityId}`,{
        headers:{Authorization:"Bearer "+token}
    });
    const bolos = await res.json();
    boloList.innerHTML = "";

    bolos.forEach(b => boloList.innerHTML += `
        <div class="card">
            <b>${b.type}</b> â€” ${b.description}<br>
            Plate: ${b.plate || "N/A"}<br>
            <button class="btn-danger btn-small" onclick='deleteBOLO("${b._id}")'>Delete</button>
        </div>
    `);
}

async function createBOLO() {
    await fetch(`${API}/bolos/create`,{
        method:"POST",
        headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},
        body:JSON.stringify({
            communityId,
            type:boloType.value,
            plate:boloPlate.value,
            description:boloDesc.value
        })
    });

    closeBoloModal();
    loadBOLOs();
}

async function deleteBOLO(id) {
    await fetch(`${API}/bolos/delete/${id}`,{
        method:"DELETE",
        headers:{Authorization:"Bearer "+token}
    });
    loadBOLOs();
}


/* ============================================================
   MODALS & LOGOUT
============================================================ */
function openNewCallModal(){ newCallModal.style.display = "flex"; }
function closeNewCallModal(){ newCallModal.style.display = "none"; }
function openBoloModal(){ boloModal.style.display = "flex"; }
function closeBoloModal(){ boloModal.style.display = "none"; }

function logout(){
    localStorage.clear();
    location.href = "login.html";
}

/* INIT */
loadCalls();
loadUnits();
loadBOLOs();
</script>
</body>
</html>
