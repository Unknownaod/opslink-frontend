<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supervisor Console – OpsLinkCAD</title>
<link rel="stylesheet" href="css/style.css">

<style>
body {
    margin: 0;
    background: #0f141a;
    color: #c9d1d9;
    font-family: "Segoe UI", sans-serif;
}

/* SIDEBAR */
.sidebar {
    width: 240px;
    height: 100vh;
    background: #0d1117;
    border-right: 1px solid #161b22;
    padding: 20px;
    position: fixed;
}
.sidebar .logo {
    font-size: 26px;
    margin-bottom: 26px;
}
.sidebar a {
    display: block;
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 6px;
    color: #c9d1d9;
    text-decoration: none;
}
.sidebar a:hover,
.sidebar a.active {
    background: #1a222e;
    color: #4ea1ff;
}

/* MAIN */
.main {
    margin-left: 260px;
    padding: 25px;
}
h1 {
    margin-top: 0;
}

/* CARDS */
.card {
    background: #161b22;
    border: 1px solid #1e2630;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}
.card h2 {
    margin-top: 0;
    color: #4ea1ff;
}

/* TABLE */
table { width: 100%; border-collapse: collapse; }
th {
    padding: 8px;
    background: #1e2630;
    text-align: left;
}
td {
    padding: 8px;
    border-bottom: 1px solid #1f2933;
}

/* BUTTONS */
button {
    padding: 7px 14px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}
.btn-primary { background: #4ea1ff; color: #fff; }
.btn-warning { background: #f1c40f; color: #000; }
.btn-danger { background: #e74c3c; color: white; }
.btn-dark { background: #1f2630; color:#4ea1ff; border:1px solid #4ea1ff; }

/* MODALS */
.modal-bg {
    position: fixed;
    width:100%; height:100%;
    top:0; left:0;
    background:rgba(0,0,0,.7);
    display:none;
    justify-content:center;
    align-items:center;
}
.modal {
    background:#161b22;
    width:380px;
    padding:20px;
    border-radius:8px;
    border:1px solid #4ea1ff;
}
.modal input,
.modal textarea {
    width:100%;
    padding:10px;
    background:#0f141a;
    border:1px solid #333;
    border-radius:6px;
    color:#fff;
}
</style>
</head>


<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="logo">OpsLink<span style="color:#4ea1ff;">CAD</span></div>

    <a href="dashboard.html">Dashboard</a>
    <a href="community.html">Community</a>
    <a href="dispatch.html">Dispatch</a>
    <a href="#" class="active">Supervisor</a>
    <a href="#" onclick="logout()">Logout</a>
</div>


<!-- MAIN -->
<div class="main">

    <h1>Supervisor Console</h1>
    <p id="connectionStatus" style="opacity:.6;margin-bottom:18px;">Connecting...</p>

    <!-- UNITS -->
    <div class="card">
        <h2>Unit Control</h2>

        <table>
            <thead>
                <tr>
                    <th>Callsign</th>
                    <th>Status</th>
                    <th>Dept</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="unitList"></tbody>
        </table>
    </div>

    <!-- CALLS -->
    <div class="card">
        <h2>Active Calls</h2>

        <table>
            <thead>
                <tr>
                    <th>Call</th>
                    <th>Status</th>
                    <th>Units</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="callList"></tbody>
        </table>
    </div>

    <!-- BROADCAST -->
    <div class="card">
        <h2>Supervisor Broadcast</h2>

        <textarea id="broadcastMsg" placeholder="Message to send to all units..." style="width:100%;height:90px;"></textarea>
        <button class="btn-primary" onclick="sendBroadcast()">Send Broadcast</button>
    </div>
</div>



<!-- SOCKET + LOGIC -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
/* ============================================================
   CONFIG / PERMISSION LOCK
   ============================================================ */
const API = "https://opslink-api.onrender.com";
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user"));
const communityId = localStorage.getItem("selectedCommunity");

const permissions = JSON.parse(localStorage.getItem("permissions")) || [];
const role = localStorage.getItem("communityRole") || "member";

// SUPERVISOR ACCESS REQUIRED
if (!permissions.includes("supervisor") && !permissions.includes("admin") && role !== "owner") {
    alert("You do not have supervisor permissions.");
    window.location.href = "community.html";
}


/* ============================================================
   SOCKET.IO LIVE
   ============================================================ */
const socket = io(API);

socket.on("connect", () => {
    document.getElementById("connectionStatus").innerText = "Connected ✓";
});

socket.on("unit:status", loadUnits);
socket.on("unit:location", loadUnits);
socket.on("unit:panic", loadUnits);
socket.on("unit:forceOffline", loadUnits);

socket.on("call:update", loadCalls);


/* ============================================================
   LOAD UNITS
   ============================================================ */
async function loadUnits() {
    const res = await fetch(`${API}/units/${communityId}`, {
        headers: { "Authorization": "Bearer " + token }
    });
    const units = await res.json();

    const list = document.getElementById("unitList");
    list.innerHTML = "";

    units.forEach(u => {
        let statusColor = u.status === "10-8" ? "#2ecc71"
                     : u.status === "10-7" ? "#e74c3c"
                     : u.status === "panic" ? "#ff0033"
                     : "#f1c40f";

        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${u.callsign}</td>
            <td style="color:${statusColor};">${u.status}</td>
            <td>${u.type || "LEO"}</td>
            <td>
                <button class="btn-warning btn-small" onclick="force107('${u._id}')">Force 10-7</button>
                <button class="btn-danger btn-small" onclick="clearPanic('${u._id}')">Clear Panic</button>
            </td>
        `;

        list.appendChild(row);
    });
}


/* ============================================================
   FORCE 10-7 UNIT
   ============================================================ */
async function force107(unitId) {
    await fetch(`${API}/units/${unitId}/forceOffline`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
    });
    socket.emit("unit:forceOffline");
    loadUnits();
}


/* ============================================================
   CLEAR PANIC
   ============================================================ */
async function clearPanic(unitId) {
    await fetch(`${API}/units/${unitId}/status`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
        body: JSON.stringify({ status: "10-8" })
    });

    socket.emit("unit:status");
    loadUnits();
}


/* ============================================================
   LOAD CALLS
   ============================================================ */
async function loadCalls() {
    const res = await fetch(`${API}/calls/${communityId}`, {
        headers: { "Authorization": "Bearer " + token }
    });
    const calls = await res.json();

    const list = document.getElementById("callList");
    list.innerHTML = "";

    calls.forEach(c => {
        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${c.title}</td>
            <td>${c.status}</td>
            <td>${c.units?.join(", ") || ""}</td>
            <td>
                <button class="btn-dark btn-small" onclick="forceClose('${c._id}')">Close</button>
            </td>
        `;

        list.appendChild(row);
    });
}


/* ============================================================
   SUPERVISOR CLOSE CALL
   ============================================================ */
async function forceClose(id) {
    await fetch(`${API}/calls/${id}/status`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ status: "closed" })
    });

    socket.emit("call:update");
    loadCalls();
}


/* ============================================================
   BROADCAST MESSAGE
   ============================================================ */
async function sendBroadcast() {
    const msg = document.getElementById("broadcastMsg").value.trim();
    if (!msg) return alert("Enter a message.");

    socket.emit("supervisor:broadcast", {
        communityId,
        sender: user.email,
        message: msg,
        time: Date.now()
    });

    alert("Broadcast sent.");
    document.getElementById("broadcastMsg").value = "";
}


/* ============================================================
   LOGOUT
   ============================================================ */
function logout() {
    localStorage.clear();
    window.location.href = "login.html";
}


/* INIT */
loadUnits();
loadCalls();
</script>

</body>
</html>
