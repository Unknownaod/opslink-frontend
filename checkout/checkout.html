<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OpsLinkCAD â€“ Secure Checkout</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ============================================
   GLOBAL THEME (OpsLink Premium)
============================================ */
body {
    margin: 0;
    background: #06090f;
    color: #d8e0ea;
    font-family: "Segoe UI", sans-serif;
}

.checkout-wrapper {
    max-width: 1100px;
    margin: 60px auto;
    display: flex;
    gap: 35px;
    padding: 0 25px;
}

/* LEFT PANEL */
.checkout-left {
    flex: 1;
    background: rgba(255,255,255,0.05);
    padding: 35px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.07);
    backdrop-filter: blur(14px);
}

.section-title {
    font-size: 22px;
    margin-bottom: 12px;
    font-weight: 600;
}

label {
    display: block;
    font-size: 14px;
    margin-top: 15px;
    margin-bottom: 6px;
    opacity: 0.9;
}

input, select {
    width: 100%;
    padding: 12px;
    background: #0b111a;
    border: 1px solid #1e2633;
    border-radius: 8px;
    color: #d8e0ea;
    font-size: 15px;
}

#card-element {
    padding: 14px;
    border-radius: 8px;
    background: #0b111a;
    border: 1px solid #1e2633;
    margin-top: 6px;
}

/* PAY BUTTON */
.btn-pay {
    margin-top: 25px;
    width: 100%;
    padding: 15px;
    background: #4e8cff;
    border: none;
    border-radius: 10px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    font-size: 17px;
    transition: .25s;
}

.btn-pay:hover {
    background: #3b6fcc;
}

/* RIGHT PANEL */
.checkout-right {
    width: 350px;
    background: rgba(255,255,255,0.04);
    padding: 30px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.07);
    backdrop-filter: blur(14px);
}

.summary-title {
    font-size: 20px;
    margin-bottom: 15px;
    font-weight: 600;
}

.summary-box {
    background: rgba(255,255,255,0.03);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
}

.summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 15px;
}

.total-line {
    border-top: 1px solid rgba(255,255,255,0.08);
    margin-top: 15px;
    padding-top: 15px;
    font-size: 17px;
    font-weight: 700;
}

/* FEATURES */
.feature-list {
    margin-top: 25px;
    font-size: 14px;
    opacity: 0.9;
}

.feature-list div {
    margin-bottom: 8px;
}

.secure {
    text-align: center;
    margin-top: 18px;
    font-size: 13px;
    opacity: 0.7;
}

/* MOBILE */
@media (max-width: 900px) {
    .checkout-wrapper {
        flex-direction: column;
    }
    .checkout-right {
        width: 100%;
    }
}
</style>

</head>
<body>

<div class="checkout-wrapper">

    <!-- ================= LEFT PANEL ================= -->
    <div class="checkout-left">

        <div class="section-title">Customer Information</div>

        <label>Full Name</label>
        <input id="fullname" placeholder="John Doe">

        <label>Email Address</label>
        <input id="email" placeholder="you@example.com">

        <label>Billing Address</label>
        <input id="address" placeholder="123 Main St">

        <label>City</label>
        <input id="city" placeholder="Toronto">

        <label>Country</label>
        <select id="country">
            <option value="CA">Canada</option>
            <option value="US">United States</option>
            <option value="UK">United Kingdom</option>
            <option value="AU">Australia</option>
        </select>

        <!-- ZIP + STATE will go here dynamically -->
        <div id="locationContainer"></div>

        <div class="section-title" style="margin-top:30px;">Payment Method</div>

        <label>Card Details</label>
        <div id="card-element"></div>

<!-- LEGAL CONSENT -->
<div style="margin-top:25px; font-size:14px; opacity:0.85;">
    <label style="display:flex; align-items:flex-start; gap:10px; cursor:pointer;">
        <input type="checkbox" id="agreement" style="margin-top:3px;">
        <span>
            I agree and give consent for OpsLinkCAD to charge <b>$12.99 USD monthly</b> on a recurring basis. 
            I understand this subscription will renew automatically unless cancelled, and I authorize recurring charges 
            to the payment method I provide. I confirm that I have read and agree to the 
            <a href="#" style="color:#4e8cff;">Terms of Service</a> and 
            <a href="#" style="color:#4e8cff;">Billing Policy</a>.
        </span>
    </label>
</div>

<button id="activateBtn" class="btn-pay" style="opacity:0.5; cursor:not-allowed;" disabled onclick="startPayment()">
    Activate Premier
</button>


        <p id="msg" style="text-align:center;margin-top:15px;"></p>

    </div>

    <!-- ================= RIGHT PANEL ================= -->
    <div class="checkout-right">

        <div class="summary-title">Order Summary</div>

        <div class="summary-box">
            <div class="summary-item">
                <span>OpsLink Premier</span>
                <span>$12.99/mo</span>
            </div>

            <div class="summary-item">
                <span>Subtotal</span>
                <span id="subtotal">$12.99</span>
            </div>

            <div class="summary-item">
                <span>Estimated Tax</span>
                <span id="tax">$0.00</span>
            </div>

            <div class="total-line">
                <span>Total Due Today</span>
                <span id="total">$12.99</span>
            </div>
        </div>

        <div class="feature-list">
            <div>âœ“ Unlimited Communities</div>
            <div>âœ“ Custom Branding</div>
            <div>âœ“ Priority Support</div>
            <div>âœ“ Full Access to All Features</div>
            <div>âœ“ Cancel Anytime</div>
        </div>

        <div class="secure">ðŸ”’ Payments are securely processed and encrypted.</div>
    </div>

</div>

<!-- Stripe -->
<script src="https://js.stripe.com/v3/"></script>

<script>
/* =====================================================
   STRIPE
===================================================== */
let stripe = Stripe("YOUR_PUBLISHABLE_KEY");
let elements = stripe.elements();
let card = elements.create("card", {
    style: {
        base: {
            color: "#d8e0ea",
            fontSize: "16px",
            fontFamily: "Segoe UI"
        }
    }
});
card.mount("#card-element");

/* =====================================================
   BASE PRICE
===================================================== */
const BASE_PRICE = 12.99;

/* =====================================================
   TAX RATES
===================================================== */

// Canada HST/GST/QST
const provinces_CA = {
    "AB": 0.05, "BC": 0.05, "MB": 0.05, "NB": 0.15, "NL": 0.15,
    "NT": 0.05, "NS": 0.15, "NU": 0.05, "ON": 0.13, "PE": 0.15,
    "QC": 0.14975, "SK": 0.05, "YT": 0.05
};

// UK VAT
const RATE_UK = 0.20;

// Australia GST
const RATE_AU = 0.10;

// USA â†’ no default tax
const states_US = {
    "AL":0,"AK":0,"AZ":0,"AR":0,"CA":0,"CO":0,"CT":0,"DE":0,"FL":0,"GA":0,
    "HI":0,"ID":0,"IL":0,"IN":0,"IA":0,"KS":0,"KY":0,"LA":0,"ME":0,"MD":0,
    "MA":0,"MI":0,"MN":0,"MS":0,"MO":0,"MT":0,"NE":0,"NV":0,"NH":0,"NJ":0,
    "NM":0,"NY":0,"NC":0,"ND":0,"OH":0,"OK":0,"OR":0,"PA":0,"RI":0,"SC":0,
    "SD":0,"TN":0,"TX":0,"UT":0,"VT":0,"VA":0,"WA":0,"WV":0,"WI":0,"WY":0
};

/* =====================================================
   DYNAMIC LOCATION FIELDS
===================================================== */

const locationContainer = document.getElementById("locationContainer");

// Create ZIP + STATE/PROVINCE fields
locationContainer.innerHTML = `
    <label>Postal / ZIP Code</label>
    <input id="zip" placeholder="Postal Code">

    <label id="stateLabel" style="display:none">State / Province</label>
    <select id="stateSelect" style="
        display:none;
        width:100%;
        padding:12px;
        background:#0b111a;
        border:1px solid #1e2633;
        border-radius:8px;
        color:#d8e0ea;
        font-size:15px;
    "></select>
`;

const countryEl = document.getElementById("country");
const stateLabel = document.getElementById("stateLabel");
const stateSelect = document.getElementById("stateSelect");
const zipEl = document.getElementById("zip");

function loadStates() {
    const country = countryEl.value;

    stateSelect.innerHTML = "";

    if (country === "CA") {
        stateLabel.style.display = "block";
        stateSelect.style.display = "block";
        for (let code in provinces_CA) {
            const opt = document.createElement("option");
            opt.value = code;
            opt.innerText = code;
            stateSelect.appendChild(opt);
        }
    }
    else if (country === "US") {
        stateLabel.style.display = "block";
        stateSelect.style.display = "block";
        for (let code in states_US) {
            const opt = document.createElement("option");
            opt.value = code;
            opt.innerText = code;
            stateSelect.appendChild(opt);
        }
    }
    else {
        stateLabel.style.display = "none";
        stateSelect.style.display = "none";
    }

    updateTotals();
}

/* =====================================================
   PRICE CALCULATOR
===================================================== */

const subtotalEl = document.getElementById("subtotal");
const taxEl = document.getElementById("tax");
const totalEl = document.getElementById("total");

function updateTotals() {
    const country = countryEl.value;
    const province = stateSelect.value;

    let taxRate = 0;

    if (country === "CA" && provinces_CA[province] !== undefined) {
        taxRate = provinces_CA[province];
    }

    if (country === "UK") taxRate = RATE_UK;
    if (country === "AU") taxRate = RATE_AU;

    // USA stays 0%

    const subtotal = BASE_PRICE;
    const tax = subtotal * taxRate;
    const total = subtotal + tax;

    subtotalEl.innerHTML = `$${subtotal.toFixed(2)}`;
    taxEl.innerHTML = `$${tax.toFixed(2)}`;
    totalEl.innerHTML = `$${total.toFixed(2)}`;
}

/* INITIAL */
loadStates();
updateTotals();

countryEl.addEventListener("change", loadStates);
stateSelect.addEventListener("change", updateTotals);
zipEl.addEventListener("input", updateTotals);


/* =====================================================
   AGREEMENT CHECKBOX (LEGAL COMPLIANCE)
===================================================== */
const agreement = document.getElementById("agreement");
const activateBtn = document.getElementById("activateBtn");

agreement.addEventListener("change", () => {
    if (agreement.checked) {
        activateBtn.disabled = false;
        activateBtn.style.opacity = "1";
        activateBtn.style.cursor = "pointer";
    } else {
        activateBtn.disabled = true;
        activateBtn.style.opacity = "0.5";
        activateBtn.style.cursor = "not-allowed";
    }
});


   
/* =====================================================
   PAYMENT PROCESS
===================================================== */
async function startPayment() {
    document.getElementById("msg").innerText = "Processing...";

    const token = localStorage.getItem("token");

    const customer = {
        fullname: document.getElementById("fullname").value,
        email: document.getElementById("email").value,
        address: document.getElementById("address").value,
        city: document.getElementById("city").value,
        country: countryEl.value,
        zip: zipEl.value
    };

    const res = await fetch("https://opslink-api.onrender.com/billing/create-subscription", {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify(customer)
    });

    const data = await res.json();

    const result = await stripe.confirmCardPayment(data.clientSecret, {
        payment_method: {
            card: card,
            billing_details: {
                name: customer.fullname,
                email: customer.email,
                address: {
                    line1: customer.address,
                    city: customer.city,
                    postal_code: customer.zip,
                    country: customer.country
                }
            }
        }
    });

    if (result.error) {
        document.getElementById("msg").innerText = result.error.message;
    } else {
        window.location.href = "../dashboard.html?upgraded=true";
    }
}
</script>

</body>
</html>

