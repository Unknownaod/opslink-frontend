<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OpsLinkCAD MDT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet (Dark Map) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
/* ============================================================================
   OPSLINK MDT — DARKCARBON THEME (Royal Blue #266BFF)
   Fully Custom Modern Law-Enforcement UI
   ============================================================================ */

/* -----------------------------
   COLOR SYSTEM
   ----------------------------- */
:root {
  --accent: #266bff;
  --accent-hover: #4b86ff;
  --danger: #ff4c4c;
  --warning: #ffb454;

  --bg-main: #0b0f15;
  --bg-panel: #121820;
  --bg-elevated: #161e24;
  --bg-carbon: #10151c url('https://i.imgur.com/sZy7qgG.png');

  --border: #1e2733;
  --border-light: #2b3542;

  --text-main: #e5eaf3;
  --text-soft: #9aa5b5;
}

/* -----------------------------
   GLOBAL
   ----------------------------- */
body {
  margin: 0;
  background: var(--bg-main);
  font-family: "Segoe UI", sans-serif;
  color: var(--text-main);
  overflow: hidden;
}

* {
  box-sizing: border-box;
}

/* Scrollbars */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #0b0f15; }
::-webkit-scrollbar-thumb { background: #1f2a38; border-radius: 4px; }

/* -----------------------------
   TOP NAVIGATION BAR
   ----------------------------- */
#topbar {
  height: 54px;
  background: var(--bg-carbon);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 20px;
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  z-index: 1000;
}

.top-tab {
  color: var(--text-soft);
  padding: 10px 16px;
  cursor: pointer;
  font-size: 15px;
  transition: 0.2s;
  border-radius: 6px;
}

.top-tab:hover {
  background: var(--bg-elevated);
  color: var(--accent);
}

.top-tab.active {
  background: var(--bg-panel);
  border: 1px solid var(--accent);
  color: var(--accent);
}

/* -----------------------------
   MAIN CONTENT AREA
   ----------------------------- */
#main {
  position: absolute;
  top: 54px;
  left: 0;
  width: 100%;
  height: calc(100vh - 54px);
  overflow-y: auto;
  padding: 20px;
}

/* -----------------------------
   PANELS
   ----------------------------- */
.panel {
  display: none;
  animation: fade 0.25s ease;
}

.panel.active {
  display: block;
}

@keyframes fade {
  from { opacity: 0; transform: translateY(5px); }
  to   { opacity: 1; transform: translateY(0px); }
}

/* -----------------------------
   UNIT HEADER
   ----------------------------- */
#unit-header {
  background: var(--bg-carbon);
  border: 1px solid var(--border-light);
  padding: 15px 18px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#unit-header .info {
  font-size: 18px;
  font-weight: 600;
  color: var(--accent);
}

#panic-btn {
  background: var(--danger);
  padding: 10px 22px;
  border: none;
  color: #fff;
  font-size: 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.2s;
}

#panic-btn:hover {
  opacity: 0.8;
}

/* -----------------------------
   STATUS BUTTONS
   ----------------------------- */
.status-grid {
  margin-top: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
}

.status-btn {
  background: var(--bg-panel);
  padding: 15px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  text-align: center;
  color: var(--text-main);
  transition: 0.2s;
}

.status-btn:hover {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

/* -----------------------------
   CALL CARDS
   ----------------------------- */
.call-card {
  background: var(--bg-panel);
  border: 1px solid var(--border-light);
  padding: 18px;
  border-radius: 8px;
  margin-bottom: 12px;
}

.call-card h3 {
  margin: 0 0 10px 0;
  color: var(--accent);
}

/* -----------------------------
   SEARCH RESULTS BOX
   ----------------------------- */
.result-box {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 15px;
  margin-top: 14px;
  white-space: pre-wrap;
}

/* -----------------------------
   MODALS (Traffic Stop / Unit Select)
   ----------------------------- */
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}

.modal-content {
  background: var(--bg-panel);
  padding: 25px;
  width: 500px;
  border: 1px solid var(--border);
  border-radius: 8px;
}

.modal-content h2 {
  margin-top: 0;
  color: var(--accent);
  margin-bottom: 15px;
}

.modal input, .modal select, .modal textarea {
  width: 100%;
  padding: 12px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  color: var(--text-main);
  border-radius: 6px;
  margin-top: 12px;
  resize: none;
  font-size: 14px;
}

.modal .btn {
  margin-top: 20px;
  width: 100%;
}

/* -----------------------------
   GENERIC BUTTONS
   ----------------------------- */
.btn {
  padding: 12px 20px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: 0.2s;
}

.btn:hover {
  background: var(--accent-hover);
}

.btn-danger {
  background: var(--danger);
}

.btn-danger:hover {
  opacity: 0.8;
}

/* -----------------------------
   MAP PANEL (Dark Leaflet)
   ----------------------------- */
#map {
  width: 100%;
  height: calc(100vh - 120px);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  margin-top: 10px;
}

/* Dark map tile effect */
.leaflet-control-attribution {
  display: none;
}

/* -----------------------------
   UNIT PROFILE PANEL
   ----------------------------- */
.profile-card {
  background: var(--bg-panel);
  border: 1px solid var(--border-light);
  padding: 20px;
  border-radius: 8px;
  width: 420px;
}

.profile-row {
  margin-bottom: 8px;
  font-size: 15px;
}

.profile-row span {
  color: var(--text-soft);
}
</style>
</head>

<body>

<!-- ============================================================
     TOP NAVIGATION BAR
     ============================================================ -->
<div id="topbar">
  <div class="top-tab active" data-target="panel-dashboard">Dashboard</div>
  <div class="top-tab" data-target="panel-calls">Calls</div>
  <div class="top-tab" data-target="panel-search">Search</div>
  <div class="top-tab" data-target="panel-bolos">BOLOs</div>
  <div class="top-tab" data-target="panel-map">Map</div>
  <div class="top-tab" data-target="panel-profile">Unit Profile</div>
</div>

<!-- ============================================================
     MAIN CONTENT
     ============================================================ -->
<div id="main">

  <!-- ============================================================
       UNIT HEADER
       ============================================================ -->
  <div id="unit-header">
    <div class="info" id="unit-info">Unit: Loading...</div>

    <button id="panic-btn">PANIC BUTTON</button>
  </div>

  <!-- ============================================================
       DASHBOARD PANEL
       ============================================================ -->
  <div id="panel-dashboard" class="panel active">

    <h2>Status Controls</h2>

    <div class="status-grid">
      <div class="status-btn" data-status="10-8">10-8 (Available)</div>
      <div class="status-btn" data-status="10-7">10-7 (Unavailable)</div>
      <div class="status-btn" data-status="10-6">10-6 (Busy)</div>
      <div class="status-btn" data-status="10-23">10-23 (On Scene)</div>
      <div class="status-btn" data-status="Enroute">En Route</div>
      <div class="status-btn" data-status="Clearing">Clearing</div>
      <div class="status-btn" data-status="TrafficStop">Traffic Stop</div>
      <div class="status-btn" data-status="LunchBreak">Lunch Break</div>
    </div>

  </div>


  <!-- ============================================================
       CALLS PANEL
       ============================================================ -->
  <div id="panel-calls" class="panel">
    <h2>Active Calls</h2>
    <div id="calls-list"></div>
  </div>


  <!-- ============================================================
       SEARCH PANEL
       ============================================================ -->
  <div id="panel-search" class="panel">

    <h2>Search Database</h2>

    <h3 style="margin-top:20px;">Person Search</h3>
    <input id="search-person-name" placeholder="Enter a name..." />
    <button class="btn" onclick="searchPerson()">Search</button>
    <div id="search-person-result" class="result-box"></div>

    <h3 style="margin-top:30px;">Vehicle Search</h3>
    <input id="search-plate" placeholder="Enter plate number..." />
    <button class="btn" onclick="searchVehicle()">Search</button>
    <div id="search-vehicle-result" class="result-box"></div>

  </div>


  <!-- ============================================================
       BOLO PANEL
       ============================================================ -->
  <div id="panel-bolos" class="panel">
    <h2>BOLO List</h2>
    <div id="bolo-list">No BOLOs found.</div>
  </div>


  <!-- ============================================================
       MAP PANEL (LIVE UNIT TRACKING)
       ============================================================ -->
  <div id="panel-map" class="panel">
    <h2>Live Unit Tracking</h2>
    <div id="map"></div>
  </div>


  <!-- ============================================================
       UNIT PROFILE PANEL
       ============================================================ -->
  <div id="panel-profile" class="panel">

    <h2>Your Unit Profile</h2>

    <div class="profile-card">
      <div class="profile-row"><span>Callsign:</span> <b id="profile-callsign">Loading...</b></div>
      <div class="profile-row"><span>Rank:</span> <b id="profile-rank">Loading...</b></div>
      <div class="profile-row"><span>Department:</span> <b id="profile-dept">Loading...</b></div>
      <div class="profile-row"><span>Status:</span> <b id="profile-status">Loading...</b></div>
      <div class="profile-row"><span>Last Updated:</span> <b id="profile-updated">Loading...</b></div>
    </div>

  </div>

</div>


<!-- ============================================================
     TRAFFIC STOP MODAL
     ============================================================ -->
<div id="trafficModal" class="modal">
  <div class="modal-content">
    <h2>Record Traffic Stop</h2>

    <input id="ts-plate" placeholder="Plate Number" />
    <input id="ts-color" placeholder="Vehicle Color" />
    <input id="ts-model" placeholder="Vehicle Model" />
    <textarea id="ts-notes" rows="4" placeholder="Notes..."></textarea>

    <button class="btn" onclick="submitTrafficStop()">Submit</button>
    <button class="btn btn-danger" onclick="closeTrafficModal()">Cancel</button>
  </div>
</div>


<!-- ============================================================
     UNIT CREATION MODAL (REPLACES OLD UNIT SELECT)
     ============================================================ -->
<div id="unitModal" class="modal" style="display:flex;">
  <div class="modal-content">
    <h2>Create Your Unit</h2>

    <input id="unitName" placeholder="Officer Name (e.g., J. Smith)" />
    <input id="unitCallsign" placeholder="Callsign (e.g., 2B-21)" />
    <input id="unitDept" placeholder="Department (LEO, Fire, EMS, Dispatch)" />
    <input id="unitRank" placeholder="Rank (Officer, Trooper, Deputy)" />
    <input id="unitType" placeholder="Unit Type (Patrol, Traffic, Medic etc.)" />

    <button class="btn" onclick="createUnit()">Enter MDT</button>
  </div>
</div>


<!-- Socket.io -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<!-- Leaflet Map -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ============================================================
   CONFIG / GLOBALS
============================================================ */
const API = "https://opslink-api.onrender.com";
const socket = io(API);

const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user"));
const communityId = localStorage.getItem("selectedCommunity");
const permissions = JSON.parse(localStorage.getItem("permissions")) || [];

if (!token || !communityId) {
    alert("Session expired.");
    window.location.href = "login.html";
}

// LEO PERMISSION LOCK
if (!permissions.includes("leo")) {
    alert("You do not have permission to access the MDT.");
    window.location.href = "community.html";
}

let currentUnit = null;
let mapInstance = null;
let userMarker = null;
let autoLocationInterval = null;

/* ============================================================
   TAB SWITCHING (TOP NAV)
============================================================ */
document.querySelectorAll(".top-tab").forEach(tab => {
    tab.onclick = () => {
        document.querySelectorAll(".top-tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        const target = tab.dataset.target;

        document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
        document.getElementById(target).classList.add("active");
    };
});

/* ============================================================
   UNIT SELECT MODAL — LOAD UNITS
============================================================ */
/* ============================================================
   UNIT CREATION (NEW)
============================================================ */

async function createUnit() {
    const name = document.getElementById("unitName").value.trim();
    const callsign = document.getElementById("unitCallsign").value.trim();
    const department = document.getElementById("unitDepartmentId").value.trim();
    const rank = document.getElementById("unitRank").value.trim();
    const type = document.getElementById("unitType").value.trim();

    if (!name || !callsign || !department) {
        alert("Please enter at least Name, Callsign, and Department.");
        return;
    }

    // Create unit in backend
    const res = await fetch(`${API}/units/create`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            communityId,
            name,
            callsign,
            department,
            rank,
            type
        })
    });

    const data = await res.json();

    if (!res.ok) {
        alert(data.message || "Error creating unit.");
        return;
    }

    // Save selected unit
    currentUnit = data;

    // Update UI header
    document.getElementById("unit-info").innerText =
        `Unit: ${currentUnit.callsign} — ${currentUnit.type || "Unit"}`;

    // Close modal
    document.getElementById("unitModal").style.display = "none";

    // Load UI features
    updateProfilePanel();
    initMap();
    loadCalls();
    loadBOLOs();
    startAutoLocationUpdate();
}

/* ============================================================
   UPDATE PROFILE PANEL
============================================================ */
function updateProfilePanel() {
    document.getElementById("profile-callsign").innerText = currentUnit.callsign;
    document.getElementById("profile-rank").innerText = currentUnit.rank ?? "N/A";
    document.getElementById("profile-dept").innerText = currentUnit.departmentName ?? "N/A";
    document.getElementById("profile-status").innerText = currentUnit.status ?? "Unknown";
    document.getElementById("profile-updated").innerText = new Date().toLocaleString();
}

/* ============================================================
   STATUS BUTTONS
============================================================ */
document.querySelectorAll(".status-btn").forEach(btn => {
    btn.onclick = async () => {
        const status = btn.dataset.status;
        await fetch(`${API}/units/${currentUnit._id}/status`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ status })
        });

        socket.emit("unit:status", { unitId: currentUnit._id, status });
        currentUnit.status = status;
        updateProfilePanel();

        if (status === "TrafficStop") {
            openTrafficModal();
        }
    };
});

/* ============================================================
   PANIC BUTTON
============================================================ */
document.getElementById("panic-btn").onclick = async () => {
    socket.emit("panic:button", {
        unitId: currentUnit._id,
        callsign: currentUnit.callsign
    });

    await fetch(`${API}/units/${currentUnit._id}/panic`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
    });

    alert("PANIC SIGNAL SENT!");
};

/* ============================================================
   LOAD CALLS
============================================================ */
async function loadCalls() {
    const res = await fetch(`${API}/calls/${communityId}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    const calls = await res.json();
    const list = document.getElementById("calls-list");
    list.innerHTML = "";

    calls.forEach(call => {
        const div = document.createElement("div");
        div.className = "call-card";

        div.innerHTML = `
            <h3>Call #${call.callNumber}</h3>
            <p><b>Type:</b> ${call.type}</p>
            <p><b>Location:</b> ${call.location}</p>
            <p><b>Description:</b> ${call.description}</p>
            <button class="btn" onclick="attachToCall('${call._id}')">
                Attach to Call
            </button>
        `;

        list.appendChild(div);
    });
}

/* ============================================================
   ATTACH TO CALL
============================================================ */
async function attachToCall(callId) {
    await fetch(`${API}/calls/attach/${callId}`, {
        method: "PUT",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            unitId: currentUnit._id,
            callsign: currentUnit.callsign
        })
    });

    socket.emit("call:update");
    loadCalls();
}

/* ============================================================
   PERSON SEARCH
============================================================ */
async function searchPerson() {
    const q = document.getElementById("search-person-name").value.trim();
    if (!q) return;

    const res = await fetch(`${API}/civilians/search/${communityId}?q=${q}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    document.getElementById("search-person-result").innerText =
        JSON.stringify(data, null, 2);
}

/* ============================================================
   VEHICLE SEARCH
============================================================ */
async function searchVehicle() {
    const plate = document.getElementById("search-plate").value.trim();
    if (!plate) return;

    const res = await fetch(`${API}/vehicles/search/${communityId}?plate=${plate}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    document.getElementById("search-vehicle-result").innerText =
        JSON.stringify(data, null, 2);
}

/* ============================================================
   BOLO LIST
============================================================ */
async function loadBOLOs() {
    const res = await fetch(`${API}/bolos/${communityId}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    const bolos = await res.json();
    const list = document.getElementById("bolo-list");

    if (!bolos.length) {
        list.innerHTML = "<p>No active BOLOs.</p>";
        return;
    }

    list.innerHTML = "";
    bolos.forEach(b => {
        const div = document.createElement("div");
        div.className = "call-card";

        div.innerHTML = `
            <h3>${b.type}</h3>
            <p><b>Description:</b> ${b.description}</p>
            <p><b>Plate:</b> ${b.plate || "N/A"}</p>
        `;

        list.appendChild(div);
    });
}

/* ============================================================
   LIVE MAP SETUP
============================================================ */
function initMap() {
    mapInstance = L.map('map').setView([27.95, -82.46], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
        .addTo(mapInstance);
}

/* ============================================================
   AUTOMATIC LOCATION UPDATES (EVERY 8 SECONDS)
============================================================ */
function startAutoLocationUpdate() {
    if (autoLocationInterval) clearInterval(autoLocationInterval);

    autoLocationInterval = setInterval(() => {
        if (!navigator.geolocation) return;

        navigator.geolocation.getCurrentPosition(async pos => {
            const { latitude, longitude } = pos.coords;

            if (!currentUnit) return;

            await fetch(`${API}/units/${currentUnit._id}/location`, {
                method: "POST",
                headers: { "Authorization": "Bearer " + token,
                           "Content-Type": "application/json" },
                body: JSON.stringify({ lat: latitude, lng: longitude })
            });

            socket.emit("unit:location", {
                unitId: currentUnit._id,
                lat: latitude,
                lng: longitude
            });

            if (mapInstance) {
                if (!userMarker) {
                    userMarker = L.marker([latitude, longitude]).addTo(mapInstance);
                } else {
                    userMarker.setLatLng([latitude, longitude]);
                }
            }
        });
    }, 8000);
}

/* ============================================================
   TRAFFIC STOP MODAL
============================================================ */
function openTrafficModal() {
    document.getElementById("trafficModal").style.display = "flex";
}

function closeTrafficModal() {
    document.getElementById("trafficModal").style.display = "none";
}

async function submitTrafficStop() {
    const plate = document.getElementById("ts-plate").value;
    const color = document.getElementById("ts-color").value;
    const model = document.getElementById("ts-model").value;
    const notes = document.getElementById("ts-notes").value;

    await fetch(`${API}/traffic/create`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            communityId,
            unitId: currentUnit._id,
            callsign: currentUnit.callsign,
            plate,
            color,
            model,
            notes
        })
    });

    closeTrafficModal();
    alert("Traffic stop recorded.");
}
</script>
</body>
</html>
