<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OpsLinkCAD MDT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet (Dark Map) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
/* ============================================================================
   OPSLINK MDT — DARKCARBON THEME (Royal Blue #266BFF)
   Fully Custom Modern Law-Enforcement UI
   ============================================================================ */

/* -----------------------------
   COLOR SYSTEM
   ----------------------------- */
:root {
  --accent: #266bff;
  --accent-hover: #4b86ff;
  --danger: #ff4c4c;
  --warning: #ffb454;

  --bg-main: #0b0f15;
  --bg-panel: #121820;
  --bg-elevated: #161e24;
  --bg-carbon: #10151c url("https://i.imgur.com/sZy7qgG.png");

  --border: #1e2733;
  --border-light: #2b3542;

  --text-main: #e5eaf3;
  --text-soft: #9aa5b5;
}

/* -----------------------------
   GLOBAL
   ----------------------------- */
body {
  margin: 0;
  background: var(--bg-main);
  font-family: "Segoe UI", sans-serif;
  color: var(--text-main);
  overflow: hidden;
}

* {
  box-sizing: border-box;
}

/* Scrollbars */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  background: #0b0f15;
}
::-webkit-scrollbar-thumb {
  background: #1f2a38;
  border-radius: 4px;
}

/* -----------------------------
   TOP NAVIGATION BAR
   ----------------------------- */
#topbar {
  height: 54px;
  background: var(--bg-carbon);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 20px;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 1000;
}

.top-tab {
  color: var(--text-soft);
  padding: 10px 16px;
  cursor: pointer;
  font-size: 15px;
  transition: 0.2s;
  border-radius: 6px;
}

.top-tab:hover {
  background: var(--bg-elevated);
  color: var(--accent);
}

.top-tab.active {
  background: var(--bg-panel);
  border: 1px solid var(--accent);
  color: var(--accent);
}

/* -----------------------------
   MAIN CONTENT AREA
   ----------------------------- */
#main {
  position: absolute;
  top: 54px;
  left: 0;
  width: 100%;
  height: calc(100vh - 54px);
  overflow-y: auto;
  padding: 20px;
}

/* -----------------------------
   PANELS
   ----------------------------- */
.panel {
  display: none;
  animation: fade 0.25s ease;
}

.panel.active {
  display: block;
}

@keyframes fade {
  from {
    opacity: 0;
    transform: translateY(5px);
  }
  to {
    opacity: 1;
    transform: translateY(0px);
  }
}

/* -----------------------------
   UNIT HEADER
   ----------------------------- */
#unit-header {
  background: var(--bg-carbon);
  border: 1px solid var(--border-light);
  padding: 15px 18px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#unit-header .info {
  font-size: 18px;
  font-weight: 600;
  color: var(--accent);
}

#panic-btn {
  background: var(--danger);
  padding: 10px 22px;
  border: none;
  color: #fff;
  font-size: 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.2s;
}

#panic-btn:hover {
  opacity: 0.8;
}

/* -----------------------------
   STATUS BUTTONS
   ----------------------------- */
.status-grid {
  margin-top: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
}

.status-btn {
  background: var(--bg-panel);
  padding: 15px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  text-align: center;
  color: var(--text-main);
  transition: 0.2s;
}

.status-btn:hover {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

/* -----------------------------
   CALL CARDS
   ----------------------------- */
.call-card {
  background: var(--bg-panel);
  border: 1px solid var(--border-light);
  padding: 18px;
  border-radius: 8px;
  margin-bottom: 12px;
}

.call-card h3 {
  margin: 0 0 10px 0;
  color: var(--accent);
}

/* -----------------------------
   SEARCH RESULTS BOX
   ----------------------------- */
.result-box {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 15px;
  margin-top: 14px;
  white-space: pre-wrap;
}

/* -----------------------------
   MODALS (Traffic Stop / Unit Session)
   ----------------------------- */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}

.modal-content {
  background: var(--bg-panel);
  padding: 25px;
  width: 500px;
  border: 1px solid var(--border);
  border-radius: 8px;
}

.modal-content h2 {
  margin-top: 0;
  color: var(--accent);
  margin-bottom: 15px;
}

.modal input,
.modal select,
.modal textarea {
  width: 100%;
  padding: 12px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  color: var(--text-main);
  border-radius: 6px;
  margin-top: 12px;
  resize: none;
  font-size: 14px;
}

.modal .btn {
  margin-top: 20px;
  width: 100%;
}

/* -----------------------------
   GENERIC BUTTONS
   ----------------------------- */
.btn {
  padding: 12px 20px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: 0.2s;
}

.btn:hover {
  background: var(--accent-hover);
}

.btn-danger {
  background: var(--danger);
}

.btn-danger:hover {
  opacity: 0.8;
}

/* -----------------------------
   MAP PANEL (LIVE UNIT TRACKING)
   ----------------------------- */
#map {
  width: 100%;
  height: calc(100vh - 120px);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  margin-top: 10px;
}

/* Dark map tile effect */
.leaflet-control-attribution {
  display: none;
}

/* -----------------------------
   UNIT PROFILE PANEL
   ----------------------------- */
.profile-card {
  background: var(--bg-panel);
  border: 1px solid var(--border-light);
  padding: 20px;
  border-radius: 8px;
  width: 420px;
}

.profile-row {
  margin-bottom: 8px;
  font-size: 15px;
}

.profile-row span {
  color: var(--text-soft);
}
</style>
</head>

<body>
<!-- ============================================================
     TOP NAVIGATION BAR
============================================================ -->
<div id="topbar">
  <div class="top-tab active" data-target="panel-dashboard">Dashboard</div>
  <div class="top-tab" data-target="panel-calls">Calls</div>
  <div class="top-tab" data-target="panel-search">Search</div>
  <div class="top-tab" data-target="panel-bolos">BOLOs</div>
  <div class="top-tab" data-target="panel-map">Map</div>
  <div class="top-tab" data-target="panel-profile">Unit Profile</div>
</div>

<!-- ============================================================
     MAIN CONTENT
============================================================ -->
<div id="main">
  <!-- UNIT HEADER -->
  <div id="unit-header">
    <div class="info" id="unit-info">Unit: No active session</div>
    <button id="panic-btn">PANIC BUTTON</button>
  </div>

  <!-- DASHBOARD PANEL -->
  <div id="panel-dashboard" class="panel active">
    <h2>Status Controls</h2>
    <div class="status-grid">
      <div class="status-btn" data-status="10-8">10-8 (Available)</div>
      <div class="status-btn" data-status="10-7">10-7 (Unavailable)</div>
      <div class="status-btn" data-status="10-6">10-6 (Busy)</div>
      <div class="status-btn" data-status="10-23">10-23 (On Scene)</div>
      <div class="status-btn" data-status="Enroute">En Route</div>
      <div class="status-btn" data-status="Clearing">Clearing</div>
      <div class="status-btn" data-status="TrafficStop">Traffic Stop</div>
      <div class="status-btn" data-status="LunchBreak">Lunch Break</div>
    </div>
  </div>

  <!-- CALLS PANEL -->
  <div id="panel-calls" class="panel">
    <h2>Active Calls</h2>
    <div id="calls-list"></div>
  </div>

  <!-- SEARCH PANEL -->
  <div id="panel-search" class="panel">
    <h2>Search Database</h2>

    <h3 style="margin-top:20px;">Person Search</h3>
    <input id="search-person-name" placeholder="Enter a name..." />
    <button class="btn" onclick="searchPerson()">Search</button>
    <div id="search-person-result" class="result-box"></div>

    <h3 style="margin-top:30px;">Vehicle Search</h3>
    <input id="search-plate" placeholder="Enter plate number..." />
    <button class="btn" onclick="searchVehicle()">Search</button>
    <div id="search-vehicle-result" class="result-box"></div>
  </div>

  <!-- BOLO PANEL -->
  <div id="panel-bolos" class="panel">
    <h2>BOLO List</h2>
    <div id="bolo-list">No BOLOs found.</div>
  </div>

  <!-- MAP PANEL -->
  <div id="panel-map" class="panel">
    <h2>Live Unit Tracking</h2>
    <div id="map"></div>
  </div>

  <!-- UNIT PROFILE PANEL -->
  <div id="panel-profile" class="panel">
    <h2>Your Unit Profile</h2>

    <div class="profile-card">
      <div class="profile-row">
        <span>Callsign:</span> <b id="profile-callsign">N/A</b>
      </div>
      <div class="profile-row">
        <span>Rank:</span> <b id="profile-rank">N/A</b>
      </div>
      <div class="profile-row">
        <span>Department:</span> <b id="profile-dept">N/A</b>
      </div>
      <div class="profile-row">
        <span>Status:</span> <b id="profile-status">Unknown</b>
      </div>
      <div class="profile-row">
        <span>Last Updated:</span> <b id="profile-updated">N/A</b>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================
     TRAFFIC STOP MODAL
============================================================ -->
<div id="trafficModal" class="modal">
  <div class="modal-content">
    <h2>Record Traffic Stop</h2>

    <input id="ts-plate" placeholder="Plate Number" />
    <input id="ts-color" placeholder="Vehicle Color" />
    <input id="ts-model" placeholder="Vehicle Model" />
    <textarea id="ts-notes" rows="4" placeholder="Notes..."></textarea>

    <button class="btn" onclick="submitTrafficStop()">Submit</button>
    <button class="btn btn-danger" onclick="closeTrafficModal()">Cancel</button>
  </div>
</div>

<!-- ============================================================
     UNIT SESSION MODAL (NO DB UNIT, SESSION-BASED)
============================================================ -->
<div id="unitModal" class="modal">
  <div class="modal-content">
    <h2>Create Your Unit Session</h2>

    <input id="unitName" placeholder="Officer Name (e.g., J. Smith)" />
    <input id="unitCallsign" placeholder="Callsign (e.g., 2B-21)" />
    <input
      id="unitDepartment"
      placeholder="Department (LEO, Fire, EMS, Dispatch)"
    />
    <input id="unitRank" placeholder="Rank (Officer, Trooper, Deputy)" />
    <input
      id="unitType"
      placeholder="Unit Type (Patrol, Traffic, Medic, etc.)"
    />

    <button class="btn" onclick="createUnitSession()">Enter MDT</button>
  </div>
</div>

<!-- Socket.io -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<!-- Leaflet Map -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ============================================================
   CONFIG / GLOBALS
============================================================ */
const API = "https://opslink-api.onrender.com";
const socket = io(API);

const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user") || "null");
const communityId = localStorage.getItem("selectedCommunity");
const permissions = JSON.parse(localStorage.getItem("permissions") || "[]");
const role = localStorage.getItem("communityRole") || "member";

if (!token || !communityId || !user) {
  alert("Session expired.");
  window.location.href = "login.html";
}

// LEO / Admin / Owner permission lock
if (
  !permissions.includes("leo") &&
  !permissions.includes("admin") &&
  role !== "owner"
) {
  alert("You do not have permission to access the MDT.");
  window.location.href = "community.html";
}

let currentUnit = null; // session unit object (NOT a permanent DB document)
let mapInstance = null;
let userMarker = null;
let autoLocationInterval = null;

/* ============================================================
   TAB SWITCHING (TOP NAV)
============================================================ */
document.querySelectorAll(".top-tab").forEach((tab) => {
  tab.onclick = () => {
    document
      .querySelectorAll(".top-tab")
      .forEach((t) => t.classList.remove("active"));
    tab.classList.add("active");

    const target = tab.dataset.target;

    document
      .querySelectorAll(".panel")
      .forEach((p) => p.classList.remove("active"));
    document.getElementById(target).classList.add("active");

    if (target === "panel-map" && mapInstance === null) {
      initMap();
    }
  };
});

/* ============================================================
   UNIT SESSION HELPERS
============================================================ */
function openUnitModal() {
  document.getElementById("unitModal").style.display = "flex";
}

function closeUnitModal() {
  document.getElementById("unitModal").style.display = "none";
}

/**
 * Try to restore existing MDT session from backend.
 * GET /mdt/session/me?communityId=...
 */
async function loadExistingSession() {
  try {
    const res = await fetch(
      `${API}/mdt/session/me?communityId=${communityId}`,
      {
        headers: { Authorization: "Bearer " + token },
      }
    );

    if (!res.ok) {
      // No active session -> show unit modal
      openUnitModal();
      return;
    }

    const data = await res.json();
    if (!data || !data.unit) {
      openUnitModal();
      return;
    }

    currentUnit = data.unit;
    updateUnitHeader();
    updateProfilePanel();

    // Prepare MDT
    initMap();
    loadCalls();
    loadBOLOs();
    startAutoLocationUpdate();
  } catch (err) {
    console.error("loadExistingSession error:", err);
    openUnitModal();
  }
}

/**
 * Create / start an MDT session for the logged in user.
 * POST /mdt/session/start
 * body: { communityId, name, callsign, department, rank, type }
 * returns: { unit: { ... } }
 */
async function createUnitSession() {
  const name = unitName.value.trim();
  const callsign = unitCallsign.value.trim();
  const departmentId = unitDepartment.value.trim();
  const rank = unitRank.value.trim();
  const type = unitType.value.trim();

  if (!name || !callsign || !departmentId) {
    return alert("Please enter Name, Callsign, and Department.");
  }

  try {
    // 1️⃣ Create Unit
    const unitRes = await fetch(`${API}/units/create`, {
      method: "POST",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        communityId,
        name,
        callsign,
        departmentId,
        rank,
        type,
      }),
    });

    const unit = await unitRes.json();

    if (!unitRes.ok) {
      return alert(unit.message || "Error creating unit.");
    }

    currentUnit = unit;

    // 2️⃣ Start MDT Session for this Unit
    const sessionRes = await fetch(`${API}/mdt/session/start`, {
      method: "POST",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        communityId,
        unitId: unit._id, // REQUIRED by backend
      }),
    });

    const session = await sessionRes.json();

    if (!sessionRes.ok) {
      return alert(session.message || "Error starting MDT session.");
    }

    // 3️⃣ Update UI
    updateUnitHeader();
    updateProfilePanel();
    closeUnitModal();

    initMap();
    loadCalls();
    loadBOLOs();
    startAutoLocationUpdate();

  } catch (err) {
    console.error("createUnitSession error:", err);
    alert("Error starting MDT session.");
  }
}


/* ============================================================
   UPDATE PROFILE PANEL
============================================================ */
function updateProfilePanel() {
  if (!currentUnit) return;

  document.getElementById("profile-callsign").innerText =
    currentUnit.callsign || "N/A";
  document.getElementById("profile-rank").innerText =
    currentUnit.rank || "N/A";
  document.getElementById("profile-dept").innerText =
    currentUnit.department || "N/A";
  document.getElementById("profile-status").innerText =
    currentUnit.status || "Unknown";
  document.getElementById("profile-updated").innerText =
    new Date().toLocaleString();
}

/* ============================================================
   STATUS BUTTONS (SESSION-BASED)
   POST /mdt/session/status { status }
============================================================ */
document.querySelectorAll(".status-btn").forEach((btn) => {
  btn.onclick = async () => {
    if (!currentUnit) {
      alert("You must start a unit session first.");
      openUnitModal();
      return;
    }

    const status = btn.dataset.status;

    try {
      const res = await fetch(`${API}/mdt/session/status`, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ communityId, status }),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert(data.message || "Failed to update status.");
        return;
      }

      currentUnit.status = status;
      updateProfilePanel();

      socket.emit("unit:status", {
        communityId,
        userId: user._id,
        callsign: currentUnit.callsign,
        status,
      });

      if (status === "TrafficStop") {
        openTrafficModal();
      }
    } catch (err) {
      console.error("status update error:", err);
      alert("Error updating status.");
    }
  };
});

/* ============================================================
   PANIC BUTTON
   POST /mdt/session/panic
============================================================ */
document.getElementById("panic-btn").onclick = async () => {
  if (!currentUnit) {
    alert("No active unit session.");
    return;
  }

  try {
    socket.emit("panic:button", {
      communityId,
      userId: user._id,
      callsign: currentUnit.callsign,
    });

    const res = await fetch(`${API}/mdt/session/panic`, {
      method: "POST",
      headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" },
      body: JSON.stringify({ communityId }),
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      alert(data.message || "Failed to send panic.");
      return;
    }

    alert("PANIC SIGNAL SENT!");
  } catch (err) {
    console.error("panic error:", err);
    alert("Error sending panic.");
  }
};

/* ============================================================
   LOAD CALLS
   GET /calls/:communityId
============================================================ */
async function loadCalls() {
  try {
    const res = await fetch(`${API}/calls/${communityId}`, {
      headers: { Authorization: "Bearer " + token },
    });

    const calls = await res.json();
    if (!res.ok) {
      alert(calls.message || "Failed to load calls.");
      return;
    }

    const list = document.getElementById("calls-list");
    list.innerHTML = "";

    if (!calls.length) {
      list.innerHTML = "<p>No active calls.</p>";
      return;
    }

    calls.forEach((call) => {
      const div = document.createElement("div");
      div.className = "call-card";

      div.innerHTML = `
        <h3>Call #${call.callNumber || call._id}</h3>
        <p><b>Type:</b> ${call.type || "Unknown"}</p>
        <p><b>Location:</b> ${call.location || "N/A"}</p>
        <p><b>Description:</b> ${call.description || "N/A"}</p>
        <button class="btn" onclick="attachToCall('${call._id}')">
          Attach to Call
        </button>
      `;

      list.appendChild(div);
    });
  } catch (err) {
    console.error("loadCalls error:", err);
  }
}

/* ============================================================
   ATTACH TO CALL
   PUT /calls/:callId/attach
============================================================ */
async function attachToCall(callId) {
  if (!currentUnit) {
    alert("Start your unit session first.");
    return;
  }

  try {
    const res = await fetch(`${API}/calls/${callId}/attach`, {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        communityId,
        callsign: currentUnit.callsign,
      }),
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      alert(data.message || "Failed to attach to call.");
      return;
    }

    socket.emit("call:update", { communityId });
    loadCalls();
  } catch (err) {
    console.error("attachToCall error:", err);
    alert("Error attaching to call.");
  }
}

/* ============================================================
   PERSON SEARCH
   GET /civilians/:communityId/search?q=...
============================================================ */
async function searchPerson() {
  const q = document.getElementById("search-person-name").value.trim();
  if (!q) return;

  try {
    const res = await fetch(
      `${API}/civilians/${communityId}/search?q=${encodeURIComponent(q)}`,
      {
        headers: { Authorization: "Bearer " + token },
      }
    );

    const data = await res.json();
    document.getElementById("search-person-result").innerText =
      JSON.stringify(data, null, 2);
  } catch (err) {
    console.error("searchPerson error:", err);
    document.getElementById("search-person-result").innerText =
      "Error performing person search.";
  }
}

/* ============================================================
   VEHICLE SEARCH
   GET /vehicles/:communityId/search?plate=...
============================================================ */
async function searchVehicle() {
  const plate = document.getElementById("search-plate").value.trim();
  if (!plate) return;

  try {
    const res = await fetch(
      `${API}/vehicles/${communityId}/search?plate=${encodeURIComponent(
        plate
      )}`,
      {
        headers: { Authorization: "Bearer " + token },
      }
    );

    const data = await res.json();
    document.getElementById("search-vehicle-result").innerText =
      JSON.stringify(data, null, 2);
  } catch (err) {
    console.error("searchVehicle error:", err);
    document.getElementById("search-vehicle-result").innerText =
      "Error performing vehicle search.";
  }
}

/* ============================================================
   BOLO LIST
   GET /bolos/:communityId
============================================================ */
async function loadBOLOs() {
  try {
    const res = await fetch(`${API}/bolos/${communityId}`, {
      headers: { Authorization: "Bearer " + token },
    });

    const bolos = await res.json();
    const list = document.getElementById("bolo-list");

    if (!res.ok) {
      list.innerHTML = "<p>Failed to load BOLOs.</p>";
      return;
    }

    if (!bolos.length) {
      list.innerHTML = "<p>No active BOLOs.</p>";
      return;
    }

    list.innerHTML = "";
    bolos.forEach((b) => {
      const div = document.createElement("div");
      div.className = "call-card";

      div.innerHTML = `
        <h3>${b.type || "BOLO"}</h3>
        <p><b>Description:</b> ${b.description || "N/A"}</p>
        <p><b>Plate:</b> ${b.plate || "N/A"}</p>
      `;

      list.appendChild(div);
    });
  } catch (err) {
    console.error("loadBOLOs error:", err);
  }
}

/* ============================================================
   LIVE MAP SETUP
============================================================ */
function initMap() {
  if (mapInstance) return; // only once

  mapInstance = L.map("map").setView([27.95, -82.46], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
    mapInstance
  );
}

/* ============================================================
   AUTOMATIC LOCATION UPDATES (EVERY 8 SECONDS)
   POST /mdt/session/location { lat, lng }
============================================================ */
function startAutoLocationUpdate() {
  if (autoLocationInterval) clearInterval(autoLocationInterval);

  if (!navigator.geolocation) {
    console.warn("Geolocation not supported.");
    return;
  }

  autoLocationInterval = setInterval(() => {
    if (!currentUnit) return;

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const { latitude, longitude } = pos.coords;

        try {
          await fetch(`${API}/mdt/session/location`, {
            method: "POST",
            headers: {
              Authorization: "Bearer " + token,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              communityId,
              lat: latitude,
              lng: longitude,
            }),
          });

          socket.emit("unit:location", {
            communityId,
            userId: user._id,
            callsign: currentUnit.callsign,
            lat: latitude,
            lng: longitude,
          });

          if (mapInstance) {
            if (!userMarker) {
              userMarker = L.marker([latitude, longitude]).addTo(mapInstance);
            } else {
              userMarker.setLatLng([latitude, longitude]);
            }
          }
        } catch (err) {
          console.error("location update error:", err);
        }
      },
      (err) => {
        console.warn("Geolocation error:", err.message);
      }
    );
  }, 8000);
}

/* ============================================================
   TRAFFIC STOP MODAL + ROUTE
   POST /traffic/:communityId/create
============================================================ */
function openTrafficModal() {
  document.getElementById("trafficModal").style.display = "flex";
}

function closeTrafficModal() {
  document.getElementById("trafficModal").style.display = "none";
}

async function submitTrafficStop() {
  if (!currentUnit) {
    alert("No active unit session.");
    return;
  }

  const plate = document.getElementById("ts-plate").value.trim();
  const color = document.getElementById("ts-color").value.trim();
  const model = document.getElementById("ts-model").value.trim();
  const notes = document.getElementById("ts-notes").value.trim();

  try {
    const res = await fetch(`${API}/traffic/${communityId}/create`, {
      method: "POST",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        callsign: currentUnit.callsign,
        officerName: currentUnit.name,
        plate,
        color,
        model,
        notes,
      }),
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      alert(data.message || "Failed to record traffic stop.");
      return;
    }

    closeTrafficModal();
    alert("Traffic stop recorded.");
  } catch (err) {
    console.error("submitTrafficStop error:", err);
    alert("Error recording traffic stop.");
  }
}

/* ============================================================
   INIT
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  loadExistingSession();
  loadBOLOs();
  loadCalls();
});
</script>
</body>
</html>
