<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OpsLinkCAD – Vehicle Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ============================================================
   OPSLINKCAD — SONORAN-STYLE VEHICLE MANAGER
   ============================================================ */
:root {
  --bg-main:#0c1118;--bg-elevated:#131a24;--bg-panel:#161e29;
  --border:#1f2a38;--accent:#4e8cff;--accent-hover:#73a5ff;
  --danger:#ff3b3b;--text:#e8ecf5;--text-soft:#9aa7b9;
}

body {
  margin:0;background:var(--bg-main);color:var(--text);
  font-family: "Segoe UI", sans-serif;overflow:hidden;height:100vh;
}

/* HEADER */
#topnav {
  height:55px;background:var(--bg-elevated);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;font-size:20px;font-weight:bold;
  color:var(--accent);
}

/* LAYOUT */
#layout {
  display:grid;
  grid-template-columns:380px 1fr;
  height:calc(100vh - 55px);
}

/* LEFT – VEHICLE LIST */
#left {
  background:var(--bg-elevated);
  border-right:1px solid var(--border);
  padding:20px;
  overflow-y:auto;
}

.vehicle-card {
  background:var(--bg-panel);
  border:1px solid var(--border);
  padding:12px;
  border-radius:6px;
  margin-bottom:12px;
  cursor:pointer;
}
.vehicle-card:hover { border-color:var(--accent); }

.plate { font-size:18px;color:var(--accent); }
.info { font-size:13px;color:var(--text-soft); }

/* RIGHT – VEHICLE DETAILS */
#right {
  padding:25px;
  overflow-y:auto;
}

.section {
  background:var(--bg-panel);
  padding:15px;
  border-radius:6px;
  border:1px solid var(--border);
  margin-bottom:20px;
}

.section h3 { margin-top:0;color:var(--accent); }

/* BUTTONS */
.btn {
  background:var(--accent);color:white;border:none;
  padding:10px 14px;border-radius:6px;cursor:pointer;font-size:14px;
}
.btn:hover { background:var(--accent-hover); }

.danger-btn {
  background:var(--danger);color:white;border:none;
  padding:10px 14px;border-radius:6px;cursor:pointer;
}

/* MODAL */
.modal {
  position:fixed;top:0;left:0;width:100%;height:100%;
  display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);z-index:20;
}

.modal-content {
  width:500px;background:var(--bg-panel);
  border:1px solid var(--border);padding:20px;border-radius:6px;
}

.modal input, .modal select {
  width:100%;padding:10px;margin-top:8px;
  background:var(--bg-elevated);border:1px solid var(--border);
  color:var(--text-soft);border-radius:6px;
}
</style>
</head>
<body>

<div id="topnav">
  <div>Vehicle Manager</div>
  <button class="btn" onclick="openCreate()">➕ Add Vehicle</button>
</div>

<div id="layout">

  <!-- LEFT: Vehicle List -->
  <div id="left">
    <h2 style="color:var(--accent);">Vehicles</h2>
    <input id="searchInput" placeholder="Search Plate..." oninput="searchVehicle()" 
           style="padding:10px;width:100%;border-radius:6px;background:var(--bg-panel);
           border:1px solid var(--border);color:var(--text-soft);margin-bottom:15px;">
    <div id="vehicleList"></div>
  </div>

  <!-- RIGHT: Details -->
  <div id="right">
    <h2>Select a vehicle to view details</h2>
    <div id="vehicleDetails"></div>
  </div>

</div>

<!-- CREATE VEHICLE MODAL -->
<div id="createModal" class="modal">
  <div class="modal-content">
    <h2>Create Vehicle</h2>

    <input id="vPlate" placeholder="Plate" />
    <input id="vMake" placeholder="Make" />
    <input id="vModel" placeholder="Model" />
    <input id="vColor" placeholder="Color" />
    <input id="vYear" placeholder="Year" />

    <select id="vOwner"></select>

    <select id="vStolen">
      <option value="false">Not Stolen</option>
      <option value="true">Stolen</option>
    </select>

    <select id="vBolo">
      <option value="false">BOLO: No</option>
      <option value="true">BOLO: Yes</option>
    </select>

    <button class="btn" onclick="createVehicle()">Create</button>
    <button class="danger-btn" onclick="closeCreate()">Cancel</button>
  </div>
</div>

<!-- EDIT VEHICLE MODAL -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h2>Edit Vehicle</h2>

    <input id="ePlate" />
    <input id="eMake" />
    <input id="eModel" />
    <input id="eColor" />
    <input id="eYear" />

    <select id="eOwner"></select>

    <select id="eStolen">
      <option value="false">Not Stolen</option>
      <option value="true">Stolen</option>
    </select>

    <select id="eBolo">
      <option value="false">BOLO: No</option>
      <option value="true">BOLO: Yes</option>
    </select>

    <button class="btn" onclick="saveEdit()">Save</button>
    <button class="danger-btn" onclick="closeEdit()">Cancel</button>
  </div>
</div>

<script>
// =========================================================
// CONFIG
// =========================================================
const API = "https://opslink-api.onrender.com";

let userId = localStorage.getItem("userId");
let communityId = localStorage.getItem("communityId");

let vehicles = [];
let civilians = [];
let selectedVehicle = null;

// =========================================================
// LOAD VEHICLES
// =========================================================
async function loadVehicles() {
  const res = await fetch(`${API}/vehicles/community/${communityId}`);
  vehicles = await res.json();

  const list = document.getElementById("vehicleList");
  list.innerHTML = "";

  vehicles.forEach(v => {
    const card = document.createElement("div");
    card.className = "vehicle-card";
    card.onclick = () => openDetails(v);

    card.innerHTML = `
      <div class="plate">${v.plate}</div>
      <div class="info">${v.make} ${v.model} – ${v.color}</div>
    `;

    list.appendChild(card);
  });
}

// =========================================================
// LOAD CIVILIANS FOR OWNER DROPDOWN
// =========================================================
async function loadCivilians() {
  const res = await fetch(`${API}/civilians/community/${communityId}`);
  civilians = await res.json();
}

// =========================================================
// OPEN DETAILS
// =========================================================
function openDetails(v) {
  selectedVehicle = v;

  document.getElementById("vehicleDetails").innerHTML = `
    <div class="section">
      <h3>Vehicle Info</h3>
      <p><b>Plate:</b> ${v.plate}</p>
      <p><b>Make:</b> ${v.make}</p>
      <p><b>Model:</b> ${v.model}</p>
      <p><b>Color:</b> ${v.color}</p>
      <p><b>Year:</b> ${v.year}</p>
      <p><b>Owner:</b> ${v.ownerName || "Unknown"}</p>
      <p><b>Stolen:</b> ${v.stolen ? "Yes" : "No"}</p>
      <p><b>BOLO:</b> ${v.bolo ? "Yes" : "No"}</p>

      <button class="btn" onclick="openEdit()">Edit Vehicle</button>
      <button class="danger-btn" onclick="deleteVehicle()">Delete Vehicle</button>
    </div>
  `;
}

// =========================================================
// SEARCH VEHICLES
// =========================================================
async function searchVehicle() {
  const query = searchInput.value;

  const res = await fetch(`${API}/vehicles/search/${communityId}?q=${encodeURIComponent(query)}`);
  vehicles = await res.json();

  const list = document.getElementById("vehicleList");
  list.innerHTML = "";

  vehicles.forEach(v => {
    const card = document.createElement("div");
    card.className = "vehicle-card";
    card.innerHTML = `
      <div class="plate">${v.plate}</div>
      <div class="info">${v.make} ${v.model}</div>
    `;
    card.onclick = () => openDetails(v);
    list.appendChild(card);
  });
}

// =========================================================
// CREATE VEHICLE
// =========================================================
function openCreate() {
  loadOwnerDropdown();
  document.getElementById("createModal").style.display = "flex";
}

function closeCreate() {
  document.getElementById("createModal").style.display = "none";
}

async function createVehicle() {
  const body = {
    communityId,
    plate: vPlate.value,
    make: vMake.value,
    model: vModel.value,
    color: vColor.value,
    year: vYear.value,
    stolen: vStolen.value === "true",
    bolo: vBolo.value === "true",
    ownerId: vOwner.value
  };

  await fetch(`${API}/vehicles/create`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });

  closeCreate();
  loadVehicles();
}

// =========================================================
// EDIT VEHICLE
// =========================================================
function openEdit() {
  loadOwnerDropdown(true);

  ePlate.value = selectedVehicle.plate;
  eMake.value = selectedVehicle.make;
  eModel.value = selectedVehicle.model;
  eColor.value = selectedVehicle.color;
  eYear.value = selectedVehicle.year;

  eStolen.value = selectedVehicle.stolen ? "true" : "false";
  eBolo.value = selectedVehicle.bolo ? "true" : "false";
  eOwner.value = selectedVehicle.ownerId || "";
  
  document.getElementById("editModal").style.display = "flex";
}

function closeEdit() {
  document.getElementById("editModal").style.display = "none";
}

async function saveEdit() {
  const body = {
    plate: ePlate.value,
    make: eMake.value,
    model: eModel.value,
    color: eColor.value,
    year: eYear.value,
    stolen: eStolen.value === "true",
    bolo: eBolo.value === "true",
    ownerId: eOwner.value
  };

  await fetch(`${API}/vehicles/update/${selectedVehicle._id}`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });

  closeEdit();
  loadVehicles();
}

// =========================================================
// DELETE VEHICLE
// =========================================================
async function deleteVehicle() {
  if (!confirm("Delete this vehicle?")) return;

  await fetch(`${API}/vehicles/delete/${selectedVehicle._id}`, {
    method:"DELETE"
  });

  selectedVehicle = null;
  document.getElementById("vehicleDetails").innerHTML =
    "<h2>Select a vehicle</h2>";

  loadVehicles();
}

// =========================================================
// OWNER DROPDOWN
// =========================================================
async function loadOwnerDropdown(edit = false) {
  await loadCivilians();

  const dropdown = edit ? eOwner : vOwner;
  dropdown.innerHTML = "<option value=''>Select Owner</option>";

  civilians.forEach(c => {
    const option = document.createElement("option");
    option.value = c._id;
    option.textContent = c.name;
    dropdown.appendChild(option);
  });
}

// INIT
loadVehicles();
loadCivilians();
</script>

</body>
</html>
