<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Units â€“ OpsLinkCAD</title>
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* SIDEBAR */
        .sidebar {
            width: 240px;
            background: #0f141a;
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            padding: 20px;
            border-right: 1px solid #161b22;
        }

        .sidebar .logo {
            font-size: 24px;
            margin-bottom: 20px;
            display: block;
        }

        .sidebar a {
            display: block;
            padding: 12px;
            margin: 6px 0;
            border-radius: 6px;
            color: #c9d1d9;
            text-decoration: none;
        }

        .sidebar a.active, .sidebar a:hover {
            background: #1a222e;
            color: #4e8cff;
        }

        /* MAIN */
        .main {
            margin-left: 260px;
            padding: 40px;
        }

        .unit-card {
            background: #161b22;
            border: 1px solid #222c36;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 18px;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .unit-callsign {
            font-size: 22px;
            color: #4e8cff;
        }

        .unit-meta {
            opacity: .8;
            margin-top: 8px;
            font-size: 14px;
        }

        /* BUTTONS */
        .btn-small {
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #4e8cff;
            background: transparent;
            color: #4e8cff;
            transition: .2s;
        }
        .btn-small:hover {
            background: #4e8cff;
            color: #fff;
        }

        .danger-btn {
            border-color: #ff5555;
            color: #ff5555;
        }
        .danger-btn:hover {
            background: #ff5555;
            color: #fff;
        }

        /* MODAL */
        .modal-bg {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: #161b22;
            padding: 30px;
            width: 380px;
            border-radius: 12px;
            border: 1px solid #4e8cff;
        }

        .modal input, .modal select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #0f141a;
            border: 1px solid #333;
            border-radius: 6px;
            color: white;
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="logo">OpsLink<span>CAD</span></div>

    <a href="dashboard.html">Dashboard</a>
    <a href="community.html">Community</a>
    <a href="departments.html">Departments</a>
    <a href="ranks.html">Ranks</a>
    <a href="units.html" class="active">Units</a>
    <a href="#" onclick="logout()">Logout</a>
</div>

<!-- MAIN CONTENT -->
<div class="main">
    <h1 class="dash-title">Units Manager</h1>
    <p class="user-tag">Create and manage units for this community.</p>

    <button class="btn-small" onclick="openModal()">+ Add Unit</button>

    <div id="unitList" style="margin-top:25px;">Loading...</div>
</div>

<!-- MODAL: ADD / EDIT UNIT -->
<div id="unitModal" class="modal-bg">
    <div class="modal">

        <h2 id="unitModalTitle">Create Unit</h2>

        <input id="unitCallsign" placeholder="Callsign (ex: 2L-21, MED-5)">
        
        <select id="unitDept"></select>
        <select id="unitRank"></select>

        <input id="unitMember" placeholder="Assigned Member (optional email)">

        <button class="btn-primary" onclick="saveUnit()">Save</button>
        <button class="danger-btn" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
const API = "https://opslink-api.onrender.com";
const token = localStorage.getItem("token");
const communityId = localStorage.getItem("selectedCommunity");

let editingUnitId = null;
let departments = [];
let ranks = [];

/* ================= LOAD DEPARTMENTS ================= */
async function loadDepartments() {
    const res = await fetch(`${API}/departments/${communityId}`, {
        headers: { "Authorization": "Bearer " + token }
    });
    departments = await res.json();

    const deptSelect = document.getElementById("unitDept");
    deptSelect.innerHTML = "";

    departments.forEach(dept => {
        const op = document.createElement("option");
        op.value = dept._id;
        op.innerText = `${dept.shortCode || ""} ${dept.name}`;
        deptSelect.appendChild(op);
    });
}

/* ================= LOAD RANKS (FOR SELECTED DEPT) ================= */
async function loadRanksForDept(deptId) {
    const res = await fetch(`${API}/ranks/${deptId}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    ranks = await res.json();
    const rankSelect = document.getElementById("unitRank");
    rankSelect.innerHTML = "";

    ranks.forEach(rank => {
        const op = document.createElement("option");
        op.value = rank._id;
        op.innerText = rank.name;
        rankSelect.appendChild(op);
    });
}

/* ================= LOAD UNITS ================= */
async function loadUnits() {
    const res = await fetch(`${API}/units/${communityId}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    const list = document.getElementById("unitList");
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = "<p>No units created yet.</p>";
        return;
    }

    data.forEach(unit => {
        const dept = departments.find(d => d._id === unit.departmentId);
        const rank = ranks.find(r => r._id === unit.rankId);

        const div = document.createElement("div");
        div.className = "unit-card";

        div.innerHTML = `
            <div class="unit-header">
                <div class="unit-callsign">${unit.callsign}</div>
                
                <div>
                    <button class="btn-small" onclick="openEditUnit('${unit._id}')">Edit</button>
                    <button class="btn-small danger-btn" onclick="deleteUnit('${unit._id}')">Delete</button>
                </div>
            </div>

            <div class="unit-meta">
                Dept: ${dept?.name || "Unknown"} <br>
                Rank: ${rank?.name || "Unknown"} <br>
                Assigned: ${unit.assignedTo || "None"}
            </div>
        `;

        list.appendChild(div);
    });
}

/* ================= OPEN ADD MODAL ================= */
function openModal() {
    editingUnitId = null;
    document.getElementById("unitModalTitle").innerText = "Create Unit";

    document.getElementById("unitCallsign").value = "";
    document.getElementById("unitMember").value = "";

    document.getElementById("unitModal").style.display = "flex";
}

/* ================= OPEN EDIT MODAL ================= */
async function openEditUnit(id) {
    editingUnitId = id;
    document.getElementById("unitModalTitle").innerText = "Edit Unit";

    const res = await fetch(`${API}/units/get/${id}`, {
        headers: { "Authorization": "Bearer " + token }
    });
    const unit = await res.json();

    document.getElementById("unitCallsign").value = unit.callsign;
    document.getElementById("unitMember").value = unit.assignedTo || "";

    // Set department
    document.getElementById("unitDept").value = unit.departmentId;

    await loadRanksForDept(unit.departmentId);
    document.getElementById("unitRank").value = unit.rankId;

    document.getElementById("unitModal").style.display = "flex";
}

/* ================= SAVE UNIT ================= */
async function saveUnit() {
    const callsign = document.getElementById("unitCallsign").value.trim();
    const departmentId = document.getElementById("unitDept").value;
    const rankId = document.getElementById("unitRank").value;
    const assignedTo = document.getElementById("unitMember").value.trim() || null;

    if (!callsign) {
        alert("Callsign cannot be empty.");
        return;
    }

    const body = { callsign, departmentId, rankId, assignedTo };

    let endpoint = `${API}/units/${communityId}/create`;
    let method = "POST";

    if (editingUnitId) {
        endpoint = `${API}/units/update/${editingUnitId}`;
        method = "PUT";
    }

    await fetch(endpoint, {
        method,
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
    });

    closeModal();
    loadUnits();
}

/* ================= DELETE ================= */
async function deleteUnit(id) {
    if (!confirm("Delete this unit?")) return;

    await fetch(`${API}/units/delete/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
    });

    loadUnits();
}

/* ================= MODAL CLOSE ================= */
function closeModal() {
    document.getElementById("unitModal").style.display = "none";
}

/* ================= LOGOUT ================= */
function logout() {
    localStorage.clear();
    window.location.href = "login.html";
}

/* INIT */
(async () => {
    await loadDepartments();
    await loadRanksForDept(departments[0]?._id);
    await loadUnits();
})();
</script>

</body>
</html>
