<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OpsLinkCAD • Civilian RMS</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    /* ===========================================
       PAGE THEME
    =========================================== */
    :root {
      --bg-main: #0f141a;
      --bg-card: #161b22;
      --bg-card-soft: #111721;
      --bg-hover: #1a222e;

      --border: #222c36;
      --border-soft: #1f2630;

      --accent: #4ea1ff;
      --accent-soft: #6faeff;
      --accent-muted: #2b72c9;

      --text-main: #e5e9f0;
      --text-soft: #9aa5b1;

      --danger: #ff4c4c;
      --danger-soft: #cc3b3b;

      --success: #35c96f;
      --warning: #ffb347;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg-main);
      color: var(--text-main);
      font-family: "Segoe UI", sans-serif;
    }

    /* SIDEBAR */
    .sidebar {
      width: 250px;
      height: 100vh;
      background: #0d1117;
      border-right: 1px solid #161b22;
      padding: 20px;
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
    }

    .sidebar .logo {
      font-size: 26px;
      margin-bottom: 26px;
      font-weight: 700;
      color: #fff;
    }

    .sidebar .logo span {
      color: var(--accent);
    }

    .sidebar a {
      display: block;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      color: var(--text-soft);
      text-decoration: none;
      font-size: 14px;
      transition: 0.18s;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: var(--bg-hover);
      color: var(--accent);
    }

    .sidebar a.logout-link {
      margin-top: auto;
      color: #ffb4b4;
    }

    /* MAIN */
    .main {
      margin-left: 260px;
      padding: 25px 30px 40px;
      min-height: 100vh;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .page-title {
      font-size: 28px;
      margin: 0;
      color: var(--accent);
    }

    .page-subtitle {
      font-size: 13px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .header-badge {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 11px;
      color: var(--text-soft);
      background: #111721;
    }

    /* LAYOUT GRID */
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .main {
        margin-left: 0;
        padding: 20px;
      }
      .sidebar {
        position: static;
        width: 100%;
        height: auto;
        flex-direction: row;
        align-items: center;
        overflow-x: auto;
      }
      .sidebar a {
        margin-right: 8px;
        margin-bottom: 0;
      }
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* CARDS */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 18px 18px 16px;
      border-radius: 10px;
      margin-bottom: 18px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.4);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 6px;
      font-size: 18px;
      color: var(--accent);
    }

    .card-sub {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 10px;
    }

    /* TABLES */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    th, td {
      padding: 8px 10px;
      font-size: 13px;
    }

    th {
      background: #1b2330;
      color: var(--accent);
      text-align: left;
      border-bottom: 1px solid var(--border-soft);
      font-weight: 600;
    }

    td {
      border-bottom: 1px solid var(--border-soft);
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .table-empty {
      font-size: 13px;
      opacity: 0.7;
      padding-top: 8px;
    }

    /* BUTTONS */
    button {
      padding: 7px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border: 1px solid var(--accent-soft);
      transition: 0.18s;
    }

    .btn-primary:hover {
      background: var(--accent-soft);
    }

    .btn-secondary {
      background: #1b2330;
      color: var(--accent-soft);
      border: 1px solid var(--accent-soft);
    }

    .btn-secondary:hover {
      background: var(--accent-soft);
      color: #fff;
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
      border: 1px solid var(--danger-soft);
    }

    .btn-danger:hover {
      background: var(--danger-soft);
    }

    .btn-link {
      background: transparent;
      color: var(--accent-soft);
      border: none;
      padding: 0;
      font-size: 12px;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
    }

    /* FORMS */
    input, select, textarea {
      width: 100%;
      padding: 9px 10px;
      background: #0f141a;
      border: 1px solid #313949;
      color: #fff;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
      transition: 0.15s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(78, 161, 255, 0.2);
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    .field-row {
      display: flex;
      gap: 10px;
    }

    .field-row > div {
      flex: 1;
    }

    /* TAGS / PILLS */
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border-soft);
      margin-right: 4px;
      margin-bottom: 3px;
      background: #111721;
      color: var(--text-soft);
    }

    .pill-danger {
      border-color: var(--danger-soft);
      color: #ffc2c2;
      background: rgba(255, 76, 76, 0.08);
    }

    .pill-flag {
      border-color: var(--warning);
      color: #ffd18d;
      background: rgba(255, 179, 71, 0.08);
    }

    /* MODAL */
    .modal-bg {
      position: fixed;
      width:100%; height:100%;
      top:0; left:0;
      background:rgba(0,0,0,.7);
      display:none;
      justify-content:center;
      align-items:center;
      z-index: 999;
    }

    .modal {
      background: var(--bg-card);
      width:460px;
      max-width: 95%;
      padding:20px 20px 18px;
      border-radius:10px;
      border:1px solid var(--accent);
      box-shadow: 0 15px 45px rgba(0,0,0,.5);
    }

    .modal h2 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--accent);
    }

    .modal-footer {
      margin-top: 14px;
      display:flex;
      justify-content:flex-end;
      gap: 8px;
    }

    /* LARGE MODAL FOR RMS */
    .modal-wide {
      width: 760px;
      max-width: 98%;
      max-height: 90vh;
      overflow: auto;
    }

    /* TABS */
    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--border-soft);
      margin-bottom: 12px;
      overflow-x: auto;
    }

    .tab {
      padding: 7px 14px;
      cursor: pointer;
      border-radius: 7px 7px 0 0;
      background: #151b24;
      color: var(--text-soft);
      font-size: 13px;
      white-space: nowrap;
      border: 1px solid transparent;
      border-bottom: none;
    }

    .tab.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    .panel h3 {
      margin-top: 4px;
      margin-bottom: 8px;
      font-size: 15px;
      color: var(--accent);
    }

    .subtext {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    /* LISTS */
    ul.clean {
      padding-left: 18px;
      margin-top: 5px;
    }

    ul.clean li {
      margin-bottom: 4px;
      font-size: 13px;
    }

    /* MISC */
    .muted {
      opacity: 0.7;
      font-size: 12px;
    }

    .badge-soft {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #1b2330;
      border: 1px solid #263248;
      display: inline-block;
    }

  </style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">OpsLink<span>CAD</span></div>

  <a href="dashboard.html">Dashboard</a>
  <a href="community.html">Community</a>
  <a href="mdt.html">LEO MDT</a>
  <a href="fire.html">Fire/EMS</a>
  <a href="#" class="active">Civilians</a>
  <a href="#" class="logout-link" onclick="logout()">Logout</a>
</div>

<!-- MAIN -->
<div class="main">

  <div class="page-header">
    <div>
      <h1 class="page-title">Civilian RMS</h1>
      <div class="page-subtitle">Manage civilians, vehicles, flags, licenses and history for this community.</div>
    </div>
    <div>
      <span class="header-badge" id="civHeaderCommunity">Community: Loading…</span>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: SEARCH & RESULTS -->
    <div>
      <div class="card">
        <h2>Search</h2>
        <div class="card-sub">Search civilians by name or license plate. Results are scoped to your selected community.</div>

        <input id="searchInput" placeholder="e.g. John Doe, 4GTH291, etc.">
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="btn-primary" onclick="search()">Search</button>
          <button class="btn-secondary btn-sm" onclick="clearSearch()">Clear</button>
        </div>

        <div id="searchResults" style="margin-top:15px;"></div>
      </div>
    </div>

    <!-- RIGHT: CIVILIANS LIST -->
    <div>
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <h2>Civilians</h2>
            <div class="card-sub">Your saved civilians in this community.</div>
          </div>
          <button class="btn-primary btn-sm" onclick="openModal('createCivModal')">+ New Civilian</button>
        </div>

        <table style="margin-top:10px;">
          <thead>
          <tr>
            <th>Name</th>
            <th>DOB</th>
            <th>Flags</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody id="civList"></tbody>
        </table>
        <div id="civListEmpty" class="table-empty" style="display:none;">No civilians found yet.</div>
      </div>
    </div>
  </div>
</div>

<!-- ==============================
     MODAL: CREATE CIVILIAN
================================= -->
<div id="createCivModal" class="modal-bg">
  <div class="modal">
    <h2>Create Civilian</h2>
    <div class="subtext">Create a new civilian profile within this community.</div>

    <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
      <input id="civName" placeholder="Full Name">
      <div class="field-row">
        <div><input id="civDOB" placeholder="Date of Birth (MM/DD/YYYY)"></div>
        <div><input id="civPhone" placeholder="Phone (optional)"></div>
      </div>
      <input id="civAddress" placeholder="Address (optional)">
    </div>

    <div class="modal-footer">
      <button class="btn-secondary btn-sm" onclick="closeModal('createCivModal')">Cancel</button>
      <button class="btn-primary btn-sm" onclick="createCiv()">Create Civilian</button>
    </div>
  </div>
</div>

<!-- ==============================
     MODAL: VIEW CIVILIAN RMS
================================= -->
<div id="viewCivModal" class="modal-bg">
  <div class="modal modal-wide">

    <h2 id="civTitle" style="margin-bottom:4px;">Civilian RMS</h2>
    <div class="subtext" id="civSubtitle"></div>

    <!-- TABS -->
    <div class="tabs" style="margin-top:6px;">
      <div class="tab active" data-tab="profileTab">Profile</div>
      <div class="tab" data-tab="vehiclesTab">Vehicles</div>
      <div class="tab" data-tab="licensesTab">Licenses</div>
      <div class="tab" data-tab="warrantsTab">Warrants</div>
      <div class="tab" data-tab="flagsTab">Flags</div>
      <div class="tab" data-tab="notesTab">Notes</div>
      <div class="tab" data-tab="historyTab">History</div>
    </div>

    <!-- PANELS -->
    <div id="profileTab" class="panel active">
      <h3>Identity</h3>
      <div class="subtext">Basic information about this civilian.</div>

      <div style="display:flex; flex-direction:column; gap:8px;">
        <input id="editName" placeholder="Full Name">
        <div class="field-row">
          <div><input id="editDOB" placeholder="Date of Birth (MM/DD/YYYY)"></div>
          <div><input id="editPhone" placeholder="Phone"></div>
        </div>
        <input id="editAddress" placeholder="Address">
      </div>

      <div style="margin-top:10px;">
        <button class="btn-primary btn-sm" onclick="saveProfile()">Save Profile</button>
      </div>
    </div>

    <div id="vehiclesTab" class="panel">
      <h3>Vehicles</h3>
      <div class="subtext">Vehicles registered to this civilian.</div>

      <button class="btn-secondary btn-sm" onclick="openModal('vehicleModal')">+ Add Vehicle</button>

      <table style="margin-top:12px;">
        <thead>
        <tr><th>Plate</th><th>Model</th><th>Color</th><th>Actions</th></tr>
        </thead>
        <tbody id="vehicleList"></tbody>
      </table>
      <div id="vehicleListEmpty" class="table-empty" style="display:none;">No vehicles on file.</div>
    </div>

    <div id="licensesTab" class="panel">
      <h3>Licenses</h3>
      <div class="subtext">Set license statuses for this civilian.</div>

      <label>Driver License</label>
      <select id="licDriver">
        <option value="valid">Valid</option>
        <option value="suspended">Suspended</option>
        <option value="none">None</option>
      </select>

      <label style="margin-top:8px;">Firearm License</label>
      <select id="licFirearm">
        <option value="valid">Valid</option>
        <option value="revoked">Revoked</option>
        <option value="none">None</option>
      </select>

      <label style="margin-top:8px;">Boating License</label>
      <select id="licBoating">
        <option value="valid">Valid</option>
        <option value="none">None</option>
      </select>

      <label style="margin-top:8px;">Pilot License</label>
      <select id="licPilot">
        <option value="valid">Valid</option>
        <option value="none">None</option>
      </select>

      <div style="margin-top:12px;">
        <button class="btn-primary btn-sm" onclick="saveLicenses()">Save Licenses</button>
      </div>
    </div>

    <div id="warrantsTab" class="panel">
      <h3>Warrants</h3>
      <div class="subtext">Add active or historical warrant notes.</div>

      <textarea id="warrantText" placeholder="Add warrant details..."></textarea>
      <div style="margin-top:8px;">
        <button class="btn-primary btn-sm" onclick="addWarrant()">Add Warrant</button>
      </div>

      <ul id="warrantList" class="clean"></ul>
    </div>

    <div id="flagsTab" class="panel">
      <h3>Flags</h3>
      <div class="subtext">Flags are highlighted to officers during stops or calls.</div>

      <textarea id="flagText" placeholder="Add flag (e.g. 'Armed', 'Violent History', etc.)"></textarea>
      <div style="margin-top:8px;">
        <button class="btn-primary btn-sm" onclick="addFlag()">Add Flag</button>
      </div>

      <ul id="flagList" class="clean"></ul>
    </div>

    <div id="notesTab" class="panel">
      <h3>Officer Notes</h3>
      <div class="subtext">Free-form notes visible to authorized staff.</div>

      <textarea id="noteText" placeholder="Add officer note..."></textarea>
      <div style="margin-top:8px;">
        <button class="btn-primary btn-sm" onclick="addNote()">Add Note</button>
      </div>

      <ul id="noteList" class="clean"></ul>
    </div>

    <div id="historyTab" class="panel">
      <h3>History</h3>
      <div class="subtext">Used for future integration with calls, citations, arrests.</div>
      <ul id="historyList" class="clean"></ul>
    </div>

    <div style="margin-top:14px; display:flex; justify-content:space-between; align-items:center;">
      <button class="btn-link" onclick="deleteCurrentCivilian()">Delete Civilian</button>
      <button class="btn-danger btn-sm" onclick="closeModal('viewCivModal')">Close</button>
    </div>
  </div>
</div>

<!-- ==============================
     MODAL: ADD VEHICLE
================================= -->
<div id="vehicleModal" class="modal-bg">
  <div class="modal">
    <h2>Add Vehicle</h2>
    <div class="subtext">Register a vehicle to this civilian.</div>

    <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
      <input id="vehPlate" placeholder="Plate">
      <input id="vehModel" placeholder="Model">
      <input id="vehColor" placeholder="Color">
    </div>

    <div class="modal-footer">
      <button class="btn-secondary btn-sm" onclick="closeModal('vehicleModal')">Cancel</button>
      <button class="btn-primary btn-sm" onclick="saveVehicle()">Save Vehicle</button>
    </div>
  </div>
</div>

<script>
  /* =======================================
     BASIC SETUP + PERMISSION LOCK
  ======================================= */
  const token = localStorage.getItem("token");
  const user = JSON.parse(localStorage.getItem("user") || "null");
  const communityId = localStorage.getItem("selectedCommunity");

  const permissions = JSON.parse(localStorage.getItem("permissions") || "[]");
  const role = localStorage.getItem("communityRole") || "member";

  if (!token || !user || !communityId) {
    window.location.href = "login.html";
  }

  if (
    !permissions.includes("civ") &&
    !permissions.includes("leo") &&
    !permissions.includes("admin") &&
    role !== "owner"
  ) {
    alert("You do not have access to Civilian RMS.");
    window.location.href = "community.html";
  }

  const API = "https://opslink-api.onrender.com";

  let selectedCiv = null;     // full civilian object
  let civCache = [];          // list of civilians in memory

  function $(id) {
    return document.getElementById(id);
  }

  /* =======================================
     LOAD COMMUNITY NAME FOR HEADER
  ======================================= */
  (async function loadCommunityHeader() {
    try {
      const res = await fetch(\`\${API}/community/\${communityId}\`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      if (!res.ok) return;
      const el = $("civHeaderCommunity");
      if (el) el.textContent = "Community: " + (data.name || "Unknown");
    } catch (err) {
      // ignore header errors
    }
  })();

  /* =======================================
     LOAD CIVILIANS
  ======================================= */
  async function loadCivilians() {
    try {
      const res = await fetch(\`\${API}/civilians/\${communityId}/search?q=\`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const civs = await res.json();

      civCache = Array.isArray(civs) ? civs : [];

      const list = $("civList");
      const empty = $("civListEmpty");

      list.innerHTML = "";

      if (!civCache.length) {
        empty.style.display = "block";
        return;
      } else {
        empty.style.display = "none";
      }

      civCache.forEach(c => {
        const row = document.createElement("tr");

        const flags = (c.flags || []).slice(0, 3).join(", ");
        const more = (c.flags || []).length > 3 ? " +" + ((c.flags || []).length - 3) : "";

        row.innerHTML = \`
          <td>\${c.name}</td>
          <td>\${c.dob || "N/A"}</td>
          <td>\${flags || "None"}\${more}</td>
          <td>
            <button class="btn-secondary btn-sm view-civ-btn" data-id="\${c._id}">
              Open
            </button>
          </td>
        \`;

        list.appendChild(row);
      });

      // attach click handlers after rendering
      document.querySelectorAll(".view-civ-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const civ = civCache.find(x => x._id === id);
          if (civ) openCiv(civ);
        });
      });

    } catch (err) {
      console.error("loadCivilians error:", err);
      alert("Error loading civilians.");
    }
  }

  /* =======================================
     CREATE CIVILIAN
  ======================================= */
  async function createCiv() {
    const name = $("civName").value.trim();
    const dob = $("civDOB").value.trim();
    const address = $("civAddress").value.trim();
    const phone = $("civPhone").value.trim();

    if (!name) {
      alert("Name is required.");
      return;
    }

    const body = {
      communityId,
      name,
      dob,
      address,
      phone
    };

    try {
      const res = await fetch(\`\${API}/civilians/\${communityId}/create\`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.message || "Failed to create civilian.");
        return;
      }

      closeModal("createCivModal");
      $("civName").value = "";
      $("civDOB").value = "";
      $("civAddress").value = "";
      $("civPhone").value = "";

      await loadCivilians();
    } catch (err) {
      console.error("createCiv error:", err);
      alert("Error creating civilian.");
    }
  }

  /* =======================================
     OPEN CIVILIAN RMS
  ======================================= */
  function openCiv(civ) {
    selectedCiv = civ;

    $("civTitle").innerText = civ.name || "Civilian RMS";
    $("civSubtitle").innerText =
      (civ.dob ? "DOB: " + civ.dob : "DOB: N/A") +
      (civ.address ? " • " + civ.address : "");

    $("editName").value = civ.name || "";
    $("editDOB").value = civ.dob || "";
    $("editAddress").value = civ.address || "";
    $("editPhone").value = civ.phone || "";

    loadVehicles();
    loadLicenses();
    loadWarrants();
    loadFlags();
    loadNotes();
    loadHistory();

    openModal("viewCivModal");
  }

  /* =======================================
     SAVE PROFILE TAB
  ======================================= */
  async function saveProfile() {
    if (!selectedCiv) return;

    const body = {
      name: $("editName").value.trim(),
      dob: $("editDOB").value.trim(),
      address: $("editAddress").value.trim(),
      phone: $("editPhone").value.trim()
    };

    try {
      const res = await fetch(\`\${API}/civilians/\${selectedCiv._id}\`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.message || "Failed to save profile.");
        return;
      }

      alert("Profile saved.");
      await loadCivilians();
    } catch (err) {
      console.error("saveProfile error:", err);
      alert("Error saving profile.");
    }
  }

  /* =======================================
     VEHICLES TAB
  ======================================= */
  async function loadVehicles() {
    if (!selectedCiv) return;

    try {
      const res = await fetch(\`\${API}/vehicles/\${selectedCiv._id}\`, {
        headers: { "Authorization": "Bearer " + token }
      });

      const vehicles = await res.json();
      const list = $("vehicleList");
      const empty = $("vehicleListEmpty");

      list.innerHTML = "";

      if (!Array.isArray(vehicles) || !vehicles.length) {
        empty.style.display = "block";
        return;
      } else {
        empty.style.display = "none";
      }

      vehicles.forEach(v => {
        const row = document.createElement("tr");
        row.innerHTML = \`
          <td>\${v.plate}</td>
          <td>\${v.model}</td>
          <td>\${v.color}</td>
          <td>
            <button class="btn-danger btn-sm" onclick="deleteVehicle('\${v._id}')">Delete</button>
          </td>
        \`;
        list.appendChild(row);
      });

    } catch (err) {
      console.error("loadVehicles error:", err);
      alert("Error loading vehicles.");
    }
  }

  async function saveVehicle() {
    if (!selectedCiv) return;

    const plate = $("vehPlate").value.trim();
    const model = $("vehModel").value.trim();
    const color = $("vehColor").value.trim();

    if (!plate || !model) {
      alert("Plate and model are required.");
      return;
    }

    const body = {
      ownerId: selectedCiv._id,
      communityId,
      plate,
      model,
      color
    };

    try {
      const res = await fetch(\`\${API}/vehicles/create\`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.message || "Failed to save vehicle.");
        return;
      }

      $("vehPlate").value = "";
      $("vehModel").value = "";
      $("vehColor").value = "";

      closeModal("vehicleModal");
      await loadVehicles();
    } catch (err) {
      console.error("saveVehicle error:", err);
      alert("Error saving vehicle.");
    }
  }

  async function deleteVehicle(id) {
    if (!confirm("Delete this vehicle?")) return;

    try {
      const res = await fetch(\`\${API}/vehicles/\${id}\`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.message || "Failed to delete vehicle.");
        return;
      }

      await loadVehicles();
    } catch (err) {
      console.error("deleteVehicle error:", err);
      alert("Error deleting vehicle.");
    }
  }

  /* =======================================
     LICENSES TAB
  ======================================= */
  function loadLicenses() {
    if (!selectedCiv) return;

    const lic = selectedCiv.licenses || {};

    $("licDriver").value = lic.driver || "none";
    $("licFirearm").value = lic.firearm || "none";
    $("licBoating").value = lic.boating || "none";
    $("licPilot").value = lic.pilot || "none";
  }

  async function saveLicenses() {
    if (!selectedCiv) return;

    const body = {
      licenses: {
        driver: $("licDriver").value,
        firearm: $("licFirearm").value,
        boating: $("licBoating").value,
        pilot: $("licPilot").value
      }
    };

    try {
      const res = await fetch(\`\${API}/civilians/\${selectedCiv._id}\`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.message || "Failed to save licenses.");
        return;
      }

      alert("Licenses saved.");
    } catch (err) {
      console.error("saveLicenses error:", err);
      alert("Error saving licenses.");
    }
  }

  /* =======================================
     WARRANTS TAB
  ======================================= */
  function loadWarrants() {
    if (!selectedCiv) return;

    const list = $("warrantList");
    list.innerHTML = "";

    (selectedCiv.warrants || []).forEach(w => {
      const li = document.createElement("li");
      li.innerText = w;
      list.appendChild(li);
    });
  }

  async function addWarrant() {
    if (!selectedCiv) return;

    const val = $("warrantText").value.trim();
    if (!val) return;

    const updated = [...(selectedCiv.warrants || []), val];

    try {
      const res = await fetch(\`\${API}/civilians/\${selectedCiv._id}\`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ warrants: updated })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.message || "Failed to add warrant.");
        return;
      }

      selectedCiv.warrants = updated;
      $("warrantText").value = "";
      loadWarrants();
    } catch (err) {
      console.error("addWarrant error:", err);
      alert("Error adding warrant.");
    }
  }

  /* =======================================
     FLAGS TAB
  ======================================= */
  function loadFlags() {
    if (!selectedCiv) return;

    const list = $("flagList");
    list.innerHTML = "";

    (selectedCiv.flags || []).forEach(f => {
      const li = document.createElement("li");
      li.innerHTML = \`<span class="pill pill-flag">\${f}</span>\`;
      list.appendChild(li);
    });
  }

  async function addFlag() {
    if (!selectedCiv) return;

    const val = $("flagText").value.trim();
    if (!val) return;

    const updated = [...(selectedCiv.flags || []), val];

    try {
      const res = await fetch(\`\${API}/civilians/\${selectedCiv._id}\`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ flags: updated })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.message || "Failed to add flag.");
        return;
      }

      selectedCiv.flags = updated;
      $("flagText").value = "";
      loadFlags();
    } catch (err) {
      console.error("addFlag error:", err);
      alert("Error adding flag.");
    }
  }

  /* =======================================
     NOTES TAB
  ======================================= */
  function loadNotes() {
    if (!selectedCiv) return;

    const list = $("noteList");
    list.innerHTML = "";

    (selectedCiv.notes || []).forEach(n => {
      const li = document.createElement("li");
      li.innerText = n;
      list.appendChild(li);
    });
  }

  async function addNote() {
    if (!selectedCiv) return;

    const val = $("noteText").value.trim();
    if (!val) return;

    const updated = [...(selectedCiv.notes || []), val];

    try {
      const res = await fetch(\`\${API}/civilians/\${selectedCiv._id}\`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ notes: updated })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.message || "Failed to add note.");
        return;
      }

      selectedCiv.notes = updated;
      $("noteText").value = "";
      loadNotes();
    } catch (err) {
      console.error("addNote error:", err);
      alert("Error adding note.");
    }
  }

  /* =======================================
     HISTORY TAB
  ======================================= */
  function loadHistory() {
    if (!selectedCiv) return;

    const list = $("historyList");
    list.innerHTML = "";

    (selectedCiv.history || []).forEach(h => {
      const li = document.createElement("li");
      li.innerText = h;
      list.appendChild(li);
    });
  }

  /* =======================================
     DELETE CIVILIAN (OPTIONAL)
     (Only if you implement this route)
  ======================================= */
  async function deleteCurrentCivilian() {
    if (!selectedCiv) return;
    if (!confirm("Delete this civilian and all related records?")) return;

    // Only run if you have a DELETE /civilians/:id route implemented
    try {
      const res = await fetch(\`\${API}/civilians/\${selectedCiv._id}\`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.message || "Failed to delete civilian.");
        return;
      }

      closeModal("viewCivModal");
      await loadCivilians();
    } catch (err) {
      console.error("deleteCurrentCivilian error:", err);
      alert("Error deleting civilian.");
    }
  }

  /* =======================================
     SEARCH
  ======================================= */
  async function search() {
    const q = $("searchInput").value.trim();

    try {
      const res = await fetch(\`\${API}/civilians/\${communityId}/search?q=\${encodeURIComponent(q)}\`, {
        headers: { "Authorization": "Bearer " + token }
      });

      const civs = await res.json();
      const box = $("searchResults");
      box.innerHTML = "";

      if (!Array.isArray(civs) || !civs.length) {
        box.innerHTML = '<div class="muted">No results found.</div>';
        return;
      }

      civs.forEach(c => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginBottom = "10px";

        const flags = (c.flags || []).length
          ? (c.flags || []).map(f => \`<span class="pill pill-flag">\${f}</span>\`).join(" ")
          : '<span class="muted">No flags</span>';

        card.innerHTML = \`
          <h3 style="margin:0 0 4px 0; font-size:16px;">\${c.name}</h3>
          <div class="muted">DOB: \${c.dob || "N/A"} • \${c.address || "No address on file"}</div>
          <div style="margin-top:6px;">\${flags}</div>
          <div style="margin-top:10px;">
            <button class="btn-secondary btn-sm search-open-btn" data-id="\${c._id}">Open RMS</button>
          </div>
        \`;

        box.appendChild(card);
      });

      document.querySelectorAll(".search-open-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const civ = civCache.find(x => x._id === id) || civs.find(x => x._id === id);
          if (civ) openCiv(civ);
        });
      });

    } catch (err) {
      console.error("search error:", err);
      alert("Error searching civilians.");
    }
  }

  function clearSearch() {
    $("searchInput").value = "";
    $("searchResults").innerHTML = "";
  }

  /* =======================================
     TABS
  ======================================= */
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");

      const target = tab.dataset.tab;
      document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
      const panel = document.getElementById(target);
      if (panel) panel.classList.add("active");
    });
  });

  /* =======================================
     MODALS
  ======================================= */
  function openModal(id) {
    const el = $(id);
    if (el) el.style.display = "flex";
  }

  function closeModal(id) {
    const el = $(id);
    if (el) el.style.display = "none";
  }

  /* =======================================
     LOGOUT
  ======================================= */
  function logout() {
    localStorage.clear();
    window.location.href = "login.html";
  }

  /* INIT */
  loadCivilians();
</script>

</body>
</html>
