<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OpsLinkCAD â€¢ Civilian RMS</title>
<link rel="stylesheet" href="css/style.css">

<style>
/* ===========================================
   PAGE THEME
   =========================================== */
body {
    margin: 0;
    background: #0f141a;
    color: #c9d1d9;
    font-family: "Segoe UI", sans-serif;
}

/* SIDEBAR */
.sidebar {
    width: 240px;
    height: 100vh;
    background: #0d1117;
    border-right: 1px solid #161b22;
    padding: 20px;
    position: fixed;
}
.sidebar .logo {
    font-size: 26px;
    margin-bottom: 26px;
}
.sidebar a {
    display: block;
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 6px;
    color: #c9d1d9;
    text-decoration: none;
}
.sidebar a:hover,
.sidebar a.active {
    background: #1a222e;
    color: #4ea1ff;
}

/* MAIN */
.main {
    margin-left: 260px;
    padding: 25px;
}

/* CARDS */
.card {
    background: #161b22;
    border: 1px solid #1e2630;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}
.card h2 {
    margin-top: 0;
    color: #4ea1ff;
}

/* TABS */
.tabs {
    display: flex;
    gap: 12px;
    border-bottom: 1px solid #1e2630;
    margin-bottom: 20px;
}
.tab {
    padding: 10px 18px;
    cursor: pointer;
    border-radius: 6px 6px 0 0;
    background: #1a222e;
    color: #c9d1d9;
}
.tab.active {
    background: #4ea1ff;
    color: #fff;
}

/* TAB PANELS */
.panel { display: none; }
.panel.active { display: block; }

/* TABLES */
table { width: 100%; border-collapse: collapse; }
th {
    padding: 8px;
    background: #1e2630;
    text-align: left;
}
td {
    padding: 8px;
    border-bottom: 1px solid #1f2933;
}

/* BUTTONS */
button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}
.btn-primary { background: #4ea1ff; color:#fff; }
.btn-danger { background:#e74c3c; color:#fff; }
.btn-dark { background:#1e2630; color:#4ea1ff; border:1px solid #4ea1ff; }

/* FORMS */
input, select, textarea {
    width: 100%;
    padding: 10px;
    background: #0f141a;
    border: 1px solid #333;
    color: #fff;
    border-radius: 6px;
}

/* MODAL */
.modal-bg {
    position: fixed;
    width:100%; height:100%;
    top:0; left:0;
    background:rgba(0,0,0,.7);
    display:none;
    justify-content:center;
    align-items:center;
}
.modal {
    background:#161b22;
    width:460px;
    padding:20px;
    border-radius:8px;
    border:1px solid #4ea1ff;
}
</style>
</head>


<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="logo">OpsLink<span style="color:#4ea1ff;">CAD</span></div>

    <a href="dashboard.html">Dashboard</a>
    <a href="community.html">Community</a>
    <a href="mdt.html">MDT</a>
    <a href="#" class="active">Civilians</a>
    <a href="#" onclick="logout()">Logout</a>
</div>


<!-- MAIN -->
<div class="main">

    <h1>Civilian RMS</h1>

    <!-- SEARCH -->
    <div class="card">
        <h2>Search</h2>

        <input id="searchInput" placeholder="Search by name or plate...">
        <button class="btn-primary" style="margin-top:10px;" onclick="search()">Search</button>

        <div id="searchResults" style="margin-top:15px;"></div>
    </div>

    <!-- CIVILIAN LIST -->
    <div class="card">
        <h2>Civilians</h2>

        <button class="btn-primary" onclick="openModal('createCivModal')">+ New Civilian</button>

        <table style="margin-top:15px;">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>DOB</th>
                    <th>Flags</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="civList"></tbody>
        </table>
    </div>
</div>


<!-- ==============================
     MODAL: CREATE CIVILIAN
================================= -->
<div id="createCivModal" class="modal-bg">
    <div class="modal">
        <h2>Create Civilian</h2>

        <input id="civName" placeholder="Full Name">
        <input id="civDOB" placeholder="Date of Birth (MM/DD/YYYY)">
        <input id="civAddress" placeholder="Address">
        <input id="civPhone" placeholder="Phone">

        <button class="btn-primary" onclick="createCiv()">Create Civilian</button>
        <button class="btn-danger" onclick="closeModal('createCivModal')">Cancel</button>
    </div>
</div>


<!-- ==============================
     MODAL: VIEW CIVILIAN RMS
================================= -->
<div id="viewCivModal" class="modal-bg">
<div class="modal" style="width:700px;max-height:90vh;overflow:auto;">

    <h2 id="civTitle" style="margin-bottom:15px;"></h2>

    <!-- TABS -->
    <div class="tabs">
        <div class="tab active" data-tab="profileTab">Profile</div>
        <div class="tab" data-tab="vehiclesTab">Vehicles</div>
        <div class="tab" data-tab="licensesTab">Licenses</div>
        <div class="tab" data-tab="warrantsTab">Warrants</div>
        <div class="tab" data-tab="flagsTab">Flags</div>
        <div class="tab" data-tab="notesTab">Notes</div>
        <div class="tab" data-tab="historyTab">History</div>
    </div>

    <!-- PANELS -->
    <div id="profileTab" class="panel active">
        <h3>Identity</h3>
        <input id="editName">
        <input id="editDOB">
        <input id="editAddress">
        <input id="editPhone">
        <button class="btn-primary" onclick="saveProfile()">Save Profile</button>
    </div>

    <div id="vehiclesTab" class="panel">
        <h3>Vehicles</h3>
        <button class="btn-dark" onclick="openModal('vehicleModal')">+ Add Vehicle</button>

        <table style="margin-top:15px;">
            <thead>
                <tr><th>Plate</th><th>Model</th><th>Color</th><th>Actions</th></tr>
            </thead>
            <tbody id="vehicleList"></tbody>
        </table>
    </div>

    <div id="licensesTab" class="panel">
        <h3>Licenses</h3>

        <label>Driver License</label>
        <select id="licDriver">
            <option value="valid">Valid</option>
            <option value="suspended">Suspended</option>
            <option value="none">None</option>
        </select>

        <label>Firearm License</label>
        <select id="licFirearm">
            <option value="valid">Valid</option>
            <option value="revoked">Revoked</option>
            <option value="none">None</option>
        </select>

        <label>Boating License</label>
        <select id="licBoating">
            <option value="valid">Valid</option>
            <option value="none">None</option>
        </select>

        <label>Pilot License</label>
        <select id="licPilot">
            <option value="valid">Valid</option>
            <option value="none">None</option>
        </select>

        <button class="btn-primary" style="margin-top:15px;" onclick="saveLicenses()">Save Licenses</button>
    </div>

    <div id="warrantsTab" class="panel">
        <h3>Warrants</h3>
        <textarea id="warrantText" placeholder="Add warrant..."></textarea>
        <button class="btn-primary" onclick="addWarrant()">Add Warrant</button>

        <ul id="warrantList"></ul>
    </div>

    <div id="flagsTab" class="panel">
        <h3>Flags</h3>
        <textarea id="flagText" placeholder="Add flag..."></textarea>
        <button class="btn-primary" onclick="addFlag()">Add Flag</button>

        <ul id="flagList"></ul>
    </div>

    <div id="notesTab" class="panel">
        <h3>Officer Notes</h3>
        <textarea id="noteText" placeholder="Add note..."></textarea>
        <button class="btn-primary" onclick="addNote()">Add Note</button>

        <ul id="noteList"></ul>
    </div>

    <div id="historyTab" class="panel">
        <h3>History</h3>
        <ul id="historyList"></ul>
    </div>

    <button class="btn-danger" style="margin-top:15px;" onclick="closeModal('viewCivModal')">Close</button>
</div>
</div>


<!-- ==============================
     MODAL: ADD VEHICLE
================================= -->
<div id="vehicleModal" class="modal-bg">
<div class="modal">
    <h2>Add Vehicle</h2>

    <input id="vehPlate" placeholder="Plate">
    <input id="vehModel" placeholder="Model">
    <input id="vehColor" placeholder="Color">

    <button class="btn-primary" onclick="saveVehicle()">Save Vehicle</button>
    <button class="btn-danger" onclick="closeModal('vehicleModal')">Cancel</button>
</div>
</div>



<script>
/* =======================================
   BASIC SETUP + PERMISSION LOCK
======================================= */
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user"));
const communityId = localStorage.getItem("selectedCommunity");

const permissions = JSON.parse(localStorage.getItem("permissions")) || [];
const role = localStorage.getItem("communityRole");

if (!permissions.includes("civ") &&
    !permissions.includes("leo") &&
    !permissions.includes("admin") &&
    role !== "owner") 
{
    alert("You do not have access to Civilian RMS.");
    window.location.href = "community.html";
}

const API = "https://opslink-api.onrender.com";

let selectedCiv = null;


/* =======================================
   LOAD CIVILIANS
======================================= */
async function loadCivilians() {
    const res = await fetch(`${API}/civilians/${communityId}/search?q=`, {
        headers: { "Authorization": "Bearer " + token }
    });
    const civs = await res.json();

    const list = document.getElementById("civList");
    list.innerHTML = "";

    civs.forEach(c => {
        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${c.name}</td>
            <td>${c.dob || "N/A"}</td>
            <td>${(c.flags || []).join(", ")}</td>
            <td><button class="btn-dark" onclick='openCiv(${JSON.stringify(c)})'>View</button></td>
        `;

        list.appendChild(row);
    });
}


/* =======================================
   CREATE CIVILIAN
======================================= */
async function createCiv() {
    const body = {
        communityId,
        name: civName.value,
        dob: civDOB.value,
        address: civAddress.value,
        phone: civPhone.value
    };

    const res = await fetch(`${API}/civilians/${communityId}/create`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    if (!res.ok) return alert("Failed to create civilian.");

    closeModal("createCivModal");
    loadCivilians();
}


/* =======================================
   VIEW CIVILIAN
======================================= */
function openCiv(civ) {
    selectedCiv = civ;

    civTitle.innerText = civ.name;

    editName.value = civ.name;
    editDOB.value = civ.dob || "";
    editAddress.value = civ.address || "";
    editPhone.value = civ.phone || "";

    loadVehicles();
    loadLicenses();
    loadWarrants();
    loadFlags();
    loadNotes();
    loadHistory();

    openModal("viewCivModal");
}


/* =======================================
   SAVE PROFILE TAB
======================================= */
async function saveProfile() {
    const body = {
        name: editName.value,
        dob: editDOB.value,
        address: editAddress.value,
        phone: editPhone.value
    };

    await fetch(`${API}/civilians/${selectedCiv._id}`, {
        method: "PUT",
        headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    alert("Profile saved.");
    loadCivilians();
}


/* =======================================
   VEHICLES TAB
======================================= */
async function loadVehicles() {
    const res = await fetch(`${API}/vehicles/${selectedCiv._id}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    const vehicles = await res.json();
    const list = vehicleList;
    list.innerHTML = "";

    vehicles.forEach(v => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${v.plate}</td>
            <td>${v.model}</td>
            <td>${v.color}</td>
            <td><button class="btn-danger" onclick="deleteVehicle('${v._id}')">Delete</button></td>
        `;
        list.appendChild(row);
    });
}

async function saveVehicle() {
    const body = {
        ownerId: selectedCiv._id,
        communityId,
        plate: vehPlate.value,
        model: vehModel.value,
        color: vehColor.value
    };

    await fetch(`${API}/vehicles/create`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    closeModal("vehicleModal");
    loadVehicles();
}

async function deleteVehicle(id) {
    await fetch(`${API}/vehicles/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
    });
    loadVehicles();
}


/* =======================================
   LICENSES TAB
======================================= */
function loadLicenses() {
    const lic = selectedCiv.licenses || {};

    licDriver.value = lic.driver || "none";
    licFirearm.value = lic.firearm || "none";
    licBoating.value = lic.boating || "none";
    licPilot.value = lic.pilot || "none";
}

async function saveLicenses() {
    const body = {
        licenses: {
            driver: licDriver.value,
            firearm: licFirearm.value,
            boating: licBoating.value,
            pilot: licPilot.value
        }
    };

    await fetch(`${API}/civilians/${selectedCiv._id}`, {
        method:"PUT",
        headers: { "Authorization":"Bearer "+token, "Content-Type":"application/json" },
        body: JSON.stringify(body)
    });

    alert("Licenses saved.");
}


/* =======================================
   WARRANTS TAB
======================================= */
function loadWarrants() {
    warrantList.innerHTML = "";
    (selectedCiv.warrants || []).forEach(w => {
        const li = document.createElement("li");
        li.innerText = w;
        warrantList.appendChild(li);
    });
}

async function addWarrant() {
    const w = warrantText.value.trim();
    if (!w) return;

    const updated = [...(selectedCiv.warrants || []), w];

    await fetch(`${API}/civilians/${selectedCiv._id}`, {
        method:"PUT",
        headers:{ "Authorization": "Bearer "+token, "Content-Type":"application/json" },
        body: JSON.stringify({ warrants: updated })
    });

    selectedCiv.warrants = updated;
    warrantText.value = "";
    loadWarrants();
}


/* =======================================
   FLAGS TAB
======================================= */
function loadFlags() {
    flagList.innerHTML = "";
    (selectedCiv.flags || []).forEach(f => {
        const li = document.createElement("li");
        li.innerText = f;
        flagList.appendChild(li);
    });
}

async function addFlag() {
    const f = flagText.value.trim();
    if (!f) return;

    const updated = [...(selectedCiv.flags || []), f];

    await fetch(`${API}/civilians/${selectedCiv._id}`, {
        method:"PUT",
        headers:{ "Authorization":"Bearer "+token, "Content-Type":"application/json" },
        body: JSON.stringify({ flags: updated })
    });

    selectedCiv.flags = updated;
    flagText.value = "";
    loadFlags();
}


/* =======================================
   NOTES TAB
======================================= */
function loadNotes() {
    noteList.innerHTML = "";
    (selectedCiv.notes || []).forEach(n => {
        const li = document.createElement("li");
        li.innerText = n;
        noteList.appendChild(li);
    });
}

async function addNote() {
    const n = noteText.value.trim();
    if (!n) return;

    const updated = [...(selectedCiv.notes || []), n];

    await fetch(`${API}/civilians/${selectedCiv._id}`, {
        method:"PUT",
        headers:{
            "Authorization":"Bearer "+token,
            "Content-Type":"application/json"
        },
        body: JSON.stringify({ notes: updated })
    });

    selectedCiv.notes = updated;
    noteText.value = "";
    loadNotes();
}


/* =======================================
   HISTORY TAB
======================================= */
// (Fill with citations/arrests in the future)
function loadHistory() {
    historyList.innerHTML = "";
    (selectedCiv.history || []).forEach(h => {
        const li = document.createElement("li");
        li.innerText = h;
        historyList.appendChild(li);
    });
}


/* =======================================
   SEARCH
======================================= */
async function search() {
    const q = searchInput.value;
    const res = await fetch(`${API}/civilians/${communityId}/search?q=${q}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    const civs = await res.json();
    searchResults.innerHTML = "";

    civs.forEach(c => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            <h3>${c.name}</h3>
            <p>DOB: ${c.dob || "N/A"}</p>
            <button class="btn-dark" onclick='openCiv(${JSON.stringify(c)})'>Open</button>
        `;
        searchResults.appendChild(div);
    });
}


/* =======================================
   TABS
======================================= */
document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        const target = tab.dataset.tab;

        document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));

        document.getElementById(target).classList.add("active");
    });
});


/* =======================================
   MODALS
======================================= */
function openModal(id) {
    document.getElementById(id).style.display = "flex";
}
function closeModal(id) {
    document.getElementById(id).style.display = "none";
}


/* =======================================
   LOGOUT
======================================= */
function logout() {
    localStorage.clear();
    window.location.href = "login.html";
}


/* INIT */
loadCivilians();
</script>


</body>
</html>
